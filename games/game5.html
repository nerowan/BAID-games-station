<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>救助受伤的Chris</title>
    <style>
        /* 重置默认样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e272e;
            color: #d2dae2;
            text-align: center;
            overflow: hidden;
        }

        /* 主菜单、游戏说明、排行榜、游戏结束界面、成就界面、暂停界面 */
        .screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            background: rgba(30, 39, 46, 0.95);
            padding: 40px;
            border-radius: 20px;
            display: none;
            z-index: 2;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.5s;
        }

        .active {
            display: block;
        }

        h1, h2 {
            margin-bottom: 20px;
            color: #ffa801;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        p {
            margin: 10px 0;
            text-align: left;
            line-height: 1.6;
            font-size: 18px;
        }

        button {
            padding: 12px 25px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            background-color: #00a8ff;
            color: #d2dae2;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            background-color: #0097e6;
            transform: scale(1.05);
        }

        /* HUD样式 */
        #hud {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            font-size: 20px;
            z-index: 1;
            background: rgba(26, 188, 156, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        #hud div {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #hud .bar-container {
            width: 150px;
            background-color: #555;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        #hud .bar {
            height: 20px;
            background-color: #00a8ff;
            width: 100%;
            transition: width 0.3s;
        }

        /* Canvas样式 */
        #game-canvas {
            background: linear-gradient(to bottom, #485460, #283048);
            display: none;
            margin: 0 auto;
            border: 2px solid #d2dae2;
            border-radius: 10px;
            z-index: 1;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* 游戏结束界面 */
        #game-over {
            z-index: 3;
        }

        /* Leaderboard样式 */
        #leaderboard ul {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            padding-left: 0;
            margin-bottom: 20px;
        }

        #leaderboard li {
            padding: 8px 0;
            border-bottom: 1px solid #7f8c8d;
            font-size: 18px;
        }

        /* 成就界面 */
        #achievements ul {
            list-style: none;
            text-align: left;
            padding-left: 0;
        }

        #achievements li {
            padding: 8px 0;
            border-bottom: 1px solid #7f8c8d;
            font-size: 18px;
        }

        /* 成就徽章 */
        .achievement-badge {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: #fbc531;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* 暂停提示 */
        #pause-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 15px;
            display: none;
            z-index: 4;
            color: #fff;
            font-size: 24px;
        }

        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

    </style>
</head>
<body>

    <!-- 主菜单 -->
    <div id="main-menu" class="screen active">
        <h1>救助受伤的Chris</h1>
        <button id="start-game-btn">开始游戏</button>
        <button id="instructions-btn">游戏说明</button>
        <button id="leaderboard-btn">排行榜</button>
        <button id="achievements-btn">成就</button>
        <button id="settings-btn">设置</button>
    </div>

    <!-- 游戏说明 -->
    <div id="game-instructions" class="screen">
        <h2>游戏说明</h2>
        <p><strong>背景：</strong>Chris在一次意外中受伤，现在需要你的帮助将他送到医院。</p>
        <p><strong>操作方法：</strong>使用方向键或WASD键控制Chris移动，避开障碍物和敌人，收集急救包和道具。</p>
        <p><strong>目标：</strong>在限定时间内成功到达医院，收集尽可能多的急救包和道具以提高得分。</p>
        <button id="back-from-instructions">返回主菜单</button>
    </div>

    <!-- 排行榜 -->
    <div id="leaderboard" class="screen">
        <h2>排行榜</h2>
        <ul id="leaderboard-list">
            <!-- 高分列表 -->
        </ul>
        <button id="back-from-leaderboard">返回主菜单</button>
    </div>

    <!-- 成就界面 -->
    <div id="achievements" class="screen">
        <h2>成就</h2>
        <ul id="achievements-list">
            <!-- 成就列表 -->
        </ul>
        <button id="back-from-achievements">返回主菜单</button>
    </div>

    <!-- 设置界面 -->
    <div id="settings" class="screen">
        <h2>设置</h2>
        <p>背景音乐:</p>
        <button id="toggle-music-btn">开启/关闭</button>
        <p>音效:</p>
        <button id="toggle-sound-btn">开启/关闭</button>
        <button id="back-from-settings">返回主菜单</button>
    </div>

    <!-- HUD -->
    <div id="hud" style="display: none;">
        <div>
            得分: <span id="score">0</span>
        </div>
        <div>
            生命: <span id="lives">3</span>
            <div class="bar-container">
                <div class="bar" id="lives-bar"></div>
            </div>
        </div>
        <div>
            时间: <span id="time">60</span>秒
            <div class="bar-container">
                <div class="bar" id="time-bar"></div>
            </div>
        </div>
        <div>
            关卡: <span id="level">1</span>
        </div>
    </div>

    <!-- 游戏画布 -->
    <canvas id="game-canvas" width="800" height="600"></canvas>

    <!-- 游戏结束界面 -->
    <div id="game-over" class="screen">
        <h2 id="game-over-message">游戏结束</h2>
        <p>你的得分: <span id="final-score">0</span></p>
        <button id="restart-game-btn">重新开始</button>
        <button id="back-to-menu-btn">返回主菜单</button>
    </div>

    <!-- 暂停提示 -->
    <div id="pause-overlay">游戏已暂停</div>

    <script>
        // 获取元素
        const mainMenu = document.getElementById('main-menu');
        const instructions = document.getElementById('game-instructions');
        const leaderboard = document.getElementById('leaderboard');
        const achievements = document.getElementById('achievements');
        const settings = document.getElementById('settings');
        const gameOver = document.getElementById('game-over');
        const pauseOverlay = document.getElementById('pause-overlay');
        const startGameBtn = document.getElementById('start-game-btn');
        const instructionsBtn = document.getElementById('instructions-btn');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const achievementsBtn = document.getElementById('achievements-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const backFromInstructions = document.getElementById('back-from-instructions');
        const backFromLeaderboard = document.getElementById('back-from-leaderboard');
        const backFromAchievements = document.getElementById('back-from-achievements');
        const backFromSettings = document.getElementById('back-from-settings');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('lives');
        const timeElement = document.getElementById('time');
        const levelElement = document.getElementById('level');
        const finalScoreElement = document.getElementById('final-score');
        const gameOverMessage = document.getElementById('game-over-message');
        const leaderboardList = document.getElementById('leaderboard-list');
        const achievementsList = document.getElementById('achievements-list');
        const toggleMusicBtn = document.getElementById('toggle-music-btn');
        const toggleSoundBtn = document.getElementById('toggle-sound-btn');
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // HUD Bars
        const livesBar = document.getElementById('lives-bar');
        const timeBar = document.getElementById('time-bar');

        // 游戏状态
        let gameState = 'menu'; // menu, instructions, leaderboard, achievements, settings, playing, gameover, paused
        let score = 0;
        let lives = 3;
        let timeLeft = 60;
        let level = 1;
        let gameTimer;
        let animationId;
        let isMusicOn = true;
        let isSoundOn = true;

        // 音效生成器
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(frequency, type, duration) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = type;
            oscillator.frequency.value = frequency;
            gainNode.gain.value = 0.1;

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duration / 1000);
        }

        // 玩家对象
        const player = {
            x: canvas.width / 2 - 20,
            y: canvas.height - 80,
            width: 40,
            height: 40,
            speed: 5,
            dx: 0,
            dy: 0,
            color: '#2ecc71',
            shield: false,
            speedBoost: false,
            magnet: false
        };

        // 敌人和障碍物
        const enemies = [];
        const obstacles = [];
        const items = [];
        const powerUps = [];
        const bosses = [];

        // 粒子效果
        const particles = [];

        // 控制键
        const keys = {
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false,
            w: false,
            a: false,
            s: false,
            d: false,
            p: false // 暂停键
        };

        // 初始化游戏
        function init() {
            // 绑定按钮事件
            startGameBtn.addEventListener('click', startGame);
            instructionsBtn.addEventListener('click', () => switchScreen('instructions'));
            leaderboardBtn.addEventListener('click', () => {
                loadLeaderboard();
                switchScreen('leaderboard');
            });
            achievementsBtn.addEventListener('click', () => {
                loadAchievements();
                switchScreen('achievements');
            });
            settingsBtn.addEventListener('click', () => switchScreen('settings'));
            backFromInstructions.addEventListener('click', () => switchScreen('menu'));
            backFromLeaderboard.addEventListener('click', () => switchScreen('menu'));
            backFromAchievements.addEventListener('click', () => switchScreen('menu'));
            backFromSettings.addEventListener('click', () => switchScreen('menu'));
            restartGameBtn.addEventListener('click', startGame);
            backToMenuBtn.addEventListener('click', () => switchScreen('menu'));
            toggleMusicBtn.addEventListener('click', toggleMusic);
            toggleSoundBtn.addEventListener('click', toggleSound);

            // 绑定键盘事件
            document.addEventListener('keydown', keyDown);
            document.addEventListener('keyup', keyUp);
        }

        // 切换屏幕
        function switchScreen(screen) {
            // 隐藏所有屏幕
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            mainMenu.classList.remove('active');
            instructions.classList.remove('active');
            leaderboard.classList.remove('active');
            achievements.classList.remove('active');
            settings.classList.remove('active');
            gameOver.classList.remove('active');

            if (screen === 'menu') {
                mainMenu.classList.add('active');
            } else if (screen === 'instructions') {
                instructions.classList.add('active');
            } else if (screen === 'leaderboard') {
                leaderboard.classList.add('active');
            } else if (screen === 'achievements') {
                achievements.classList.add('active');
            } else if (screen === 'settings') {
                settings.classList.add('active');
            } else if (screen === 'playing') {
                canvas.style.display = 'block';
                document.getElementById('hud').style.display = 'flex';
            } else if (screen === 'gameover') {
                gameOver.classList.add('active');
            }
        }

        // 开始游戏
        function startGame() {
            // 重置游戏状态
            score = 0;
            lives = 3;
            timeLeft = 60;
            level = 1;
            scoreElement.textContent = score;
            livesElement.textContent = lives;
            timeElement.textContent = timeLeft;
            levelElement.textContent = level;
            player.x = canvas.width / 2 - player.width / 2;
            player.y = canvas.height - 80;
            player.speed = 5;
            player.shield = false;
            player.speedBoost = false;
            player.magnet = false;
            enemies.length = 0;
            obstacles.length = 0;
            items.length = 0;
            powerUps.length = 0;
            bosses.length = 0;
            particles.length = 0;

            // 生成初始敌人、障碍物和物品
            generateEnemies(5);
            generateObstacles(5);
            generateItems(10);
            generatePowerUps(3);

            // 生成Boss敌人
            if (level % 5 === 0) {
                generateBoss();
            }

            // 切换到游戏界面
            switchScreen('playing');

            // 启动计时器和游戏循环
            gameTimer = setInterval(updateTimer, 1000);
            gameState = 'playing';
            animationId = requestAnimationFrame(gameLoop);
        }

        // 更新计时器
        function updateTimer() {
            timeLeft--;
            timeElement.textContent = timeLeft;
            const timePercentage = (timeLeft / 60) * 100;
            timeBar.style.width = `${timePercentage}%`;
            timeBar.style.backgroundColor = timePercentage > 50 ? '#00a8ff' : timePercentage > 20 ? '#f39c12' : '#e74c3c';
            if (timeLeft <= 0) {
                endGame(false);
            }
        }

        // 游戏循环
        function gameLoop() {
            if (gameState !== 'playing') return;

            update();
            draw();
            animationId = requestAnimationFrame(gameLoop);
        }

        // 更新游戏状态
        function update() {
            // 更新玩家位置
            player.dx = 0;
            player.dy = 0;
            if (keys.ArrowUp || keys.w) player.dy = -player.speed;
            if (keys.ArrowDown || keys.s) player.dy = player.speed;
            if (keys.ArrowLeft || keys.a) player.dx = -player.speed;
            if (keys.ArrowRight || keys.d) player.dx = player.speed;
            player.x += player.dx;
            player.y += player.dy;

            // 边界检测
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
            if (player.y < 0) player.y = 0;
            if (player.y + player.height > canvas.height) player.y = canvas.height - player.height;

            // 更新敌人位置
            enemies.forEach(enemy => {
                enemy.y += enemy.speed;
                if (enemy.y > canvas.height) {
                    enemy.y = -enemy.height;
                    enemy.x = Math.random() * (canvas.width - enemy.width);
                }
                // 碰撞检测
                if (isColliding(player, enemy)) {
                    if (!player.shield) {
                        lives--;
                        livesElement.textContent = lives;
                        updateLivesBar();
                        playSound(200, 'sine', 100);
                        if (isSoundOn) playSound(200, 'sine', 100);
                        // 粒子效果
                        generateParticles(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2, 'red');
                        // 移动敌人到随机位置
                        enemy.y = Math.random() * -canvas.height;
                        enemy.x = Math.random() * (canvas.width - enemy.width);
                        if (lives <= 0) {
                            endGame(false);
                        }
                    }
                }
            });

            // 更新障碍物位置
            obstacles.forEach(obstacle => {
                obstacle.y += obstacle.speed;
                if (obstacle.y > canvas.height) {
                    obstacle.y = -obstacle.height;
                    obstacle.x = Math.random() * (canvas.width - obstacle.width);
                }
                // 碰撞检测
                if (isColliding(player, obstacle)) {
                    if (!player.shield) {
                        lives--;
                        livesElement.textContent = lives;
                        updateLivesBar();
                        if (isSoundOn) playSound(200, 'sine', 100);
                        // 粒子效果
                        generateParticles(obstacle.x + obstacle.width / 2, obstacle.y + obstacle.height / 2, 'yellow');
                        // 移动障碍物到随机位置
                        obstacle.y = Math.random() * -canvas.height;
                        obstacle.x = Math.random() * (canvas.width - obstacle.width);
                        if (lives <= 0) {
                            endGame(false);
                        }
                    }
                }
            });

            // 更新物品位置
            items.forEach((item, index) => {
                item.y += item.speed;
                if (item.y > canvas.height) {
                    items.splice(index, 1);
                    generateItems(1);
                }
                // 碰撞检测（圆形与矩形）
                if (isCollidingCircleRect(item, player)) {
                    score += 10;
                    scoreElement.textContent = score;
                    updateScoreBar();
                    if (isSoundOn) playSound(400, 'square', 100);
                    // 粒子效果
                    generateParticles(item.x + item.radius, item.y + item.radius, 'green');
                    items.splice(index, 1);
                    generateItems(1);
                    checkAchievements();
                }
            });

            // 更新道具位置
            powerUps.forEach((powerUp, index) => {
                powerUp.y += powerUp.speed;
                if (powerUp.y > canvas.height) {
                    powerUps.splice(index, 1);
                    generatePowerUps(1);
                }
                // 碰撞检测（圆形与矩形）
                if (isCollidingCircleRect(powerUp, player)) {
                    activatePowerUp(powerUp.type);
                    powerUps.splice(index, 1);
                    generatePowerUps(1);
                    checkAchievements();
                }
            });

            // 更新Boss敌人位置
            bosses.forEach((boss, index) => {
                boss.y += boss.speed;
                if (boss.y > canvas.height) {
                    bosses.splice(index, 1);
                    generateBoss();
                }
                // 碰撞检测
                if (isColliding(player, boss)) {
                    if (!player.shield) {
                        lives--;
                        livesElement.textContent = lives;
                        updateLivesBar();
                        if (isSoundOn) playSound(200, 'sine', 100);
                        // 粒子效果
                        generateParticles(boss.x + boss.width / 2, boss.y + boss.height / 2, 'purple');
                        // 移动Boss到随机位置
                        boss.y = Math.random() * -canvas.height;
                        boss.x = Math.random() * (canvas.width - boss.width);
                        if (lives <= 0) {
                            endGame(false);
                        }
                    }
                }
            });

            // 粒子效果更新
            particles.forEach((particle, index) => {
                particle.x += particle.dx;
                particle.y += particle.dy;
                particle.alpha -= 0.01;
                if (particle.alpha <= 0) {
                    particles.splice(index, 1);
                }
            });
        }

        // 绘制游戏元素
        function draw() {
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 绘制动态背景
            drawBackground();

            // 绘制医院
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(canvas.width / 2 - 50, 20, 100, 30);
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('医院', canvas.width / 2, 40);

            // 绘制玩家（Chris）
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);

            // 绘制敌人
            enemies.forEach(enemy => {
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            });

            // 绘制障碍物
            obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.color;
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });

            // 绘制物品
            items.forEach(item => {
                ctx.fillStyle = item.color;
                ctx.beginPath();
                ctx.arc(item.x + item.radius, item.y + item.radius, item.radius, 0, Math.PI * 2);
                ctx.fill();
            });

            // 绘制道具
            powerUps.forEach(powerUp => {
                ctx.fillStyle = powerUp.color;
                ctx.beginPath();
                ctx.arc(powerUp.x + powerUp.radius, powerUp.y + powerUp.radius, powerUp.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(powerUp.symbol, powerUp.x + powerUp.radius, powerUp.y + powerUp.radius);
            });

            // 绘制Boss敌人
            bosses.forEach(boss => {
                ctx.fillStyle = boss.color;
                ctx.fillRect(boss.x, boss.y, boss.width, boss.height);
                // 绘制Boss生命条
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px Arial';
                ctx.fillText(`HP: ${boss.hp}`, boss.x + boss.width / 2, boss.y - 10);
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(boss.x, boss.y - 20, boss.width, 5);
                ctx.fillStyle = '#2ecc71';
                ctx.fillRect(boss.x, boss.y - 20, (boss.hp / boss.maxHp) * boss.width, 5);
            });

            // 绘制粒子效果
            particles.forEach(particle => {
                ctx.fillStyle = `rgba(${particle.color}, ${particle.alpha})`;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // 绘制动态背景
        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#283048');
            gradient.addColorStop(1, '#485460');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // 生成敌人
        function generateEnemies(count) {
            for (let i = 0; i < count; i++) {
                const typeRand = Math.random();
                let type = 'basic';
                let color = '#e74c3c';
                let speed = 2 + level * 0.5;
                if (typeRand > 0.7) {
                    type = 'fast';
                    color = '#f1c40f';
                    speed += 2;
                } else if (typeRand > 0.4) {
                    type = 'smart';
                    color = '#9b59b6';
                    speed += 1;
                }
                enemies.push({
                    x: Math.random() * (canvas.width - 40),
                    y: Math.random() * -canvas.height,
                    width: 40,
                    height: 40,
                    speed: speed,
                    color: color,
                    type: type
                });
            }
        }

        // 生成障碍物
        function generateObstacles(count) {
            for (let i = 0; i < count; i++) {
                obstacles.push({
                    x: Math.random() * (canvas.width - 50),
                    y: Math.random() * -canvas.height,
                    width: 50,
                    height: 50,
                    speed: 1 + level * 0.3,
                    color: '#f1c40f',
                    type: 'static'
                });
            }
        }

        // 生成物品
        function generateItems(count) {
            for (let i = 0; i < count; i++) {
                items.push({
                    x: Math.random() * (canvas.width - 20),
                    y: Math.random() * -canvas.height,
                    radius: 10,
                    speed: 3 + level * 0.2,
                    color: '#2ecc71'
                });
            }
        }

        // 生成道具
        function generatePowerUps(count) {
            const types = ['shield', 'speed', 'magnet', 'time', 'extraLife'];
            for (let i = 0; i < count; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                let color, symbol;
                switch(type) {
                    case 'shield':
                        color = '#9b59b6';
                        symbol = 'S';
                        break;
                    case 'speed':
                        color = '#f39c12';
                        symbol = 'F';
                        break;
                    case 'magnet':
                        color = '#2980b9';
                        symbol = 'M';
                        break;
                    case 'time':
                        color = '#27ae60';
                        symbol = 'T';
                        break;
                    case 'extraLife':
                        color = '#e74c3c';
                        symbol = 'L';
                        break;
                    default:
                        color = '#ffffff';
                        symbol = '';
                }
                powerUps.push({
                    x: Math.random() * (canvas.width - 24),
                    y: Math.random() * -canvas.height,
                    radius: 12,
                    speed: 4 + level * 0.2,
                    color: color,
                    type: type,
                    symbol: symbol
                });
            }
        }

        // 生成Boss敌人
        function generateBoss() {
            bosses.push({
                x: canvas.width / 2 - 50,
                y: -100,
                width: 100,
                height: 100,
                speed: 1,
                color: '#8e44ad',
                hp: 100,
                maxHp: 100
            });
        }

        // 激活道具
        function activatePowerUp(type) {
            switch(type) {
                case 'shield':
                    player.shield = true;
                    playSound(500, 'triangle', 300);
                    setTimeout(() => {
                        player.shield = false;
                    }, 5000);
                    break;
                case 'speed':
                    player.speed = 10;
                    playSound(600, 'triangle', 300);
                    setTimeout(() => {
                        player.speed = 5;
                    }, 5000);
                    break;
                case 'magnet':
                    player.magnet = true;
                    playSound(700, 'triangle', 300);
                    setTimeout(() => {
                        player.magnet = false;
                    }, 5000);
                    break;
                case 'time':
                    timeLeft += 15;
                    timeElement.textContent = timeLeft;
                    updateTimeBar();
                    playSound(800, 'triangle', 300);
                    break;
                case 'extraLife':
                    lives++;
                    livesElement.textContent = lives;
                    updateLivesBar();
                    playSound(900, 'triangle', 300);
                    break;
                default:
                    break;
            }
        }

        // 碰撞检测（矩形与矩形）
        function isColliding(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        // 碰撞检测（圆形与矩形）
        function isCollidingCircleRect(circle, rect) {
            // 找到圆心到矩形最近的点
            let closestX = clamp(circle.x + circle.radius, rect.x, rect.x + rect.width);
            let closestY = clamp(circle.y + circle.radius, rect.y, rect.y + rect.height);

            // 计算距离
            let distanceX = (circle.x + circle.radius) - closestX;
            let distanceY = (circle.y + circle.radius) - closestY;

            let distanceSquared = (distanceX * distanceX) + (distanceY * distanceY);
            return distanceSquared < (circle.radius * circle.radius);
        }

        // 辅助函数：限制值在min和max之间
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        // 结束游戏
        function endGame(victory) {
            clearInterval(gameTimer);
            cancelAnimationFrame(animationId);
            gameState = 'gameover';
            canvas.style.display = 'none';
            document.getElementById('hud').style.display = 'none';
            finalScoreElement.textContent = score;
            if (victory) {
                gameOverMessage.textContent = '恭喜你，成功将Chris送到医院！';
                playSound(1000, 'sawtooth', 500);
            } else {
                gameOverMessage.textContent = '游戏结束，你失败了！';
                playSound(300, 'sine', 500);
            }
            saveScore(score);
            checkAchievements();
            switchScreen('gameover');
        }

        // 保存分数到排行榜
        function saveScore(newScore) {
            let scores = JSON.parse(localStorage.getItem('chrisScores')) || [];
            scores.push(newScore);
            scores.sort((a, b) => b - a);
            scores = scores.slice(0, 10); // 只保留前10名
            localStorage.setItem('chrisScores', JSON.stringify(scores));
        }

        // 加载排行榜
        function loadLeaderboard() {
            leaderboardList.innerHTML = '';
            let scores = JSON.parse(localStorage.getItem('chrisScores')) || [];
            if (scores.length === 0) {
                leaderboardList.innerHTML = '<li>暂无高分记录</li>';
                return;
            }
            scores.forEach((score, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${score} 分`;
                leaderboardList.appendChild(li);
            });
        }

        // 加载成就
        function loadAchievements() {
            achievementsList.innerHTML = '';
            let achievementsData = JSON.parse(localStorage.getItem('chrisAchievements')) || {
                firstLevel: false,
                collect100: false,
                noDamage: false,
                bossDefeated: false,
                collector: false
            };
            if (achievementsData.firstLevel) {
                addAchievementToList('首次完成关卡');
            }
            if (achievementsData.collect100) {
                addAchievementToList('收集100个急救包');
            }
            if (achievementsData.noDamage) {
                addAchievementToList('无损通关');
            }
            if (achievementsData.bossDefeated) {
                addAchievementToList('击败Boss敌人');
            }
            if (achievementsData.collector) {
                addAchievementToList('连续收集50个急救包');
            }
            // 更多成就检查
        }

        function addAchievementToList(name) {
            const li = document.createElement('li');
            li.innerHTML = `<span class="achievement-badge"></span>${name}`;
            achievementsList.appendChild(li);
        }

        // 检查成就
        function checkAchievements() {
            let achievementsData = JSON.parse(localStorage.getItem('chrisAchievements')) || {
                firstLevel: false,
                collect100: false,
                noDamage: false,
                bossDefeated: false,
                collector: false
            };

            // 首次完成关卡
            if (level > 1 && !achievementsData.firstLevel) {
                achievementsData.firstLevel = true;
                showAchievement('首次完成关卡');
            }

            // 收集100个急救包
            if (score >= 100 && !achievementsData.collect100) {
                achievementsData.collect100 = true;
                showAchievement('收集100个急救包');
            }

            // 无损通关
            if (lives > 0 && gameState === 'gameover' && !achievementsData.noDamage) {
                achievementsData.noDamage = true;
                showAchievement('无损通关');
            }

            // 击败Boss敌人
            if (level % 5 === 0 && !achievementsData.bossDefeated) {
                achievementsData.bossDefeated = true;
                showAchievement('击败Boss敌人');
            }

            // 连续收集50个急救包
            if (score >= 50 && !achievementsData.collector) {
                achievementsData.collector = true;
                showAchievement('连续收集50个急救包');
            }

            // 保存成就
            localStorage.setItem('chrisAchievements', JSON.stringify(achievementsData));
        }

        // 成就解锁提示
        function showAchievement(name) {
            // 简单的提示（可扩展为更复杂的动画）
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(canvas.width / 2 - 150, canvas.height / 2 - 40, 300, 80);
            ctx.fillStyle = '#ffa801';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`成就解锁: ${name}`, canvas.width / 2, canvas.height / 2);
            setTimeout(() => {
                // 清除提示
                ctx.clearRect(canvas.width / 2 - 150, canvas.height / 2 - 40, 300, 80);
            }, 3000);
        }

        // 键盘按下事件
        function keyDown(e) {
            if (e.key in keys) {
                keys[e.key] = true;
            }
            // 防止按P键触发其他操作
            if (e.key === 'p' || e.key === 'P') {
                e.preventDefault();
            }
        }

        // 键盘松开事件
        function keyUp(e) {
            if (e.key in keys) {
                keys[e.key] = false;
            }
        }

        // 切换音乐
        function toggleMusic() {
            isMusicOn = !isMusicOn;
            if (isMusicOn) {
                playBackgroundMusic();
            } else {
                stopBackgroundMusic();
            }
        }

        // 切换音效
        function toggleSound() {
            isSoundOn = !isSoundOn;
        }

        // 播放背景音乐
        let backgroundMusicOscillator;
        function playBackgroundMusic() {
            backgroundMusicOscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            backgroundMusicOscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            backgroundMusicOscillator.type = 'sine';
            backgroundMusicOscillator.frequency.value = 220; // A3
            gainNode.gain.value = 0.05;

            backgroundMusicOscillator.start();
        }

        // 停止背景音乐
        function stopBackgroundMusic() {
            if (backgroundMusicOscillator) {
                backgroundMusicOscillator.stop();
                backgroundMusicOscillator.disconnect();
            }
        }

        // 暂停与继续
        function togglePause() {
            if (gameState === 'playing') {
                gameState = 'paused';
                clearInterval(gameTimer);
                cancelAnimationFrame(animationId);
                stopBackgroundMusic();
                // 显示暂停提示
                pauseOverlay.style.display = 'block';
            } else if (gameState === 'paused') {
                gameState = 'playing';
                playBackgroundMusic();
                gameTimer = setInterval(updateTimer, 1000);
                pauseOverlay.style.display = 'none';
                animationId = requestAnimationFrame(gameLoop);
            }
        }

        // 生成粒子效果
        function generateParticles(x, y, color) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x,
                    y: y,
                    radius: Math.random() * 3 + 2,
                    dx: (Math.random() - 0.5) * 4,
                    dy: (Math.random() - 0.5) * 4,
                    color: color,
                    alpha: 1
                });
            }
        }

        // 生成Boss敌人（简化版本）
        function generateBossEnemy() {
            bosses.push({
                x: canvas.width / 2 - 50,
                y: -150,
                width: 100,
                height: 100,
                speed: 1,
                color: '#8e44ad',
                hp: 100,
                maxHp: 100
            });
        }

        // 检查Boss敌人是否被击败
        function checkBossDefeat() {
            bosses.forEach((boss, index) => {
                if (boss.hp <= 0) {
                    generateParticles(boss.x + boss.width / 2, boss.y + boss.height / 2, 'purple');
                    bosses.splice(index, 1);
                    playSound(1000, 'sawtooth', 500);
                }
            });
        }

        // 游戏结束
        function endGame(victory) {
            clearInterval(gameTimer);
            cancelAnimationFrame(animationId);
            stopBackgroundMusic();
            gameState = 'gameover';
            canvas.style.display = 'none';
            document.getElementById('hud').style.display = 'none';
            finalScoreElement.textContent = score;
            if (victory) {
                gameOverMessage.textContent = '恭喜你，成功将Chris送到医院！';
                playSound(1000, 'sawtooth', 500);
            } else {
                gameOverMessage.textContent = '游戏结束，你失败了！';
                playSound(300, 'sine', 500);
            }
            saveScore(score);
            checkAchievements();
            switchScreen('gameover');
        }

        // 保存分数到排行榜
        function saveScore(newScore) {
            let scores = JSON.parse(localStorage.getItem('chrisScores')) || [];
            scores.push(newScore);
            scores.sort((a, b) => b - a);
            scores = scores.slice(0, 10); // 只保留前10名
            localStorage.setItem('chrisScores', JSON.stringify(scores));
        }

        // 加载排行榜
        function loadLeaderboard() {
            leaderboardList.innerHTML = '';
            let scores = JSON.parse(localStorage.getItem('chrisScores')) || [];
            if (scores.length === 0) {
                leaderboardList.innerHTML = '<li>暂无高分记录</li>';
                return;
            }
            scores.forEach((score, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${score} 分`;
                leaderboardList.appendChild(li);
            });
        }

        // 加载成就
        function loadAchievements() {
            achievementsList.innerHTML = '';
            let achievementsData = JSON.parse(localStorage.getItem('chrisAchievements')) || {
                firstLevel: false,
                collect100: false,
                noDamage: false,
                bossDefeated: false,
                collector: false
            };
            if (achievementsData.firstLevel) {
                addAchievementToList('首次完成关卡');
            }
            if (achievementsData.collect100) {
                addAchievementToList('收集100个急救包');
            }
            if (achievementsData.noDamage) {
                addAchievementToList('无损通关');
            }
            if (achievementsData.bossDefeated) {
                addAchievementToList('击败Boss敌人');
            }
            if (achievementsData.collector) {
                addAchievementToList('连续收集50个急救包');
            }
            // 更多成就检查
        }

        function addAchievementToList(name) {
            const li = document.createElement('li');
            li.innerHTML = `<span class="achievement-badge"></span>${name}`;
            achievementsList.appendChild(li);
        }

        // 检查成就
        function checkAchievements() {
            let achievementsData = JSON.parse(localStorage.getItem('chrisAchievements')) || {
                firstLevel: false,
                collect100: false,
                noDamage: false,
                bossDefeated: false,
                collector: false
            };

            // 首次完成关卡
            if (level > 1 && !achievementsData.firstLevel) {
                achievementsData.firstLevel = true;
                showAchievement('首次完成关卡');
            }

            // 收集100个急救包
            if (score >= 100 && !achievementsData.collect100) {
                achievementsData.collect100 = true;
                showAchievement('收集100个急救包');
            }

            // 无损通关
            if (lives > 0 && gameState === 'gameover' && !achievementsData.noDamage) {
                achievementsData.noDamage = true;
                showAchievement('无损通关');
            }

            // 击败Boss敌人
            if (level % 5 === 0 && !achievementsData.bossDefeated) {
                achievementsData.bossDefeated = true;
                showAchievement('击败Boss敌人');
            }

            // 连续收集50个急救包
            if (score >= 50 && !achievementsData.collector) {
                achievementsData.collector = true;
                showAchievement('连续收集50个急救包');
            }

            // 保存成就
            localStorage.setItem('chrisAchievements', JSON.stringify(achievementsData));
        }

        // 成就解锁提示
        function showAchievement(name) {
            // 简单的提示（可扩展为更复杂的动画）
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(canvas.width / 2 - 150, canvas.height / 2 - 40, 300, 80);
            ctx.fillStyle = '#ffa801';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`成就解锁: ${name}`, canvas.width / 2, canvas.height / 2);
            setTimeout(() => {
                // 清除提示
                ctx.clearRect(canvas.width / 2 - 150, canvas.height / 2 - 40, 300, 80);
            }, 3000);
        }

        // 键盘按下事件
        function keyDown(e) {
            if (e.key in keys) {
                keys[e.key] = true;
            }
            // 防止按P键触发其他操作
            if (e.key === 'p' || e.key === 'P') {
                e.preventDefault();
            }
        }

        // 键盘松开事件
        function keyUp(e) {
            if (e.key in keys) {
                keys[e.key] = false;
            }
        }

        // 生成粒子效果
        function generateParticles(x, y, color) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x,
                    y: y,
                    radius: Math.random() * 3 + 2,
                    dx: (Math.random() - 0.5) * 4,
                    dy: (Math.random() - 0.5) * 4,
                    color: color,
                    alpha: 1
                });
            }
        }

        // 生成Boss敌人
        function generateBoss() {
            bosses.push({
                x: canvas.width / 2 - 50,
                y: -150,
                width: 100,
                height: 100,
                speed: 1,
                color: '#8e44ad',
                hp: 100,
                maxHp: 100
            });
        }

        // 检查Boss敌人是否被击败
        function checkBossDefeat() {
            bosses.forEach((boss, index) => {
                if (boss.hp <= 0) {
                    generateParticles(boss.x + boss.width / 2, boss.y + boss.height / 2, 'purple');
                    bosses.splice(index, 1);
                    playSound(1000, 'sawtooth', 500);
                }
            });
        }

        // 激活Boss攻击（简化为Boss移动和定时发射子弹）
        function bossAttack(boss) {
            // 示例：Boss发射简单子弹
            setInterval(() => {
                if (gameState !== 'playing') return;
                bossBullets.push({
                    x: boss.x + boss.width / 2 - 5,
                    y: boss.y + boss.height,
                    width: 10,
                    height: 20,
                    speed: 4,
                    color: '#ffffff'
                });
            }, 2000);
        }

        // Boss子弹
        const bossBullets = [];

        // 更新Boss子弹
        function updateBossBullets() {
            bossBullets.forEach((bullet, index) => {
                bullet.y += bullet.speed;
                if (bullet.y > canvas.height) {
                    bossBullets.splice(index, 1);
                }
                // 碰撞检测
                if (isColliding(bullet, player)) {
                    if (!player.shield) {
                        lives--;
                        livesElement.textContent = lives;
                        updateLivesBar();
                        if (isSoundOn) playSound(200, 'sine', 100);
                        // 粒子效果
                        generateParticles(bullet.x + bullet.width / 2, bullet.y + bullet.height / 2, 'white');
                        bossBullets.splice(index, 1);
                        if (lives <= 0) {
                            endGame(false);
                        }
                    }
                }
            });
        }

        // 更新游戏状态（包含Boss子弹）
        function updateWithBoss() {
            update();
            updateBossBullets();
            checkBossDefeat();
        }

        // 更新HUD的生命值进度条
        function updateLivesBar() {
            const livesPercentage = (lives / 5) * 100; // 假设最大生命为5
            livesBar.style.width = `${livesPercentage}%`;
            livesBar.style.backgroundColor = livesPercentage > 60 ? '#2ecc71' : livesPercentage > 30 ? '#f1c40f' : '#e74c3c';
        }

        // 更新HUD的得分进度条
        function updateScoreBar() {
            // 例如，最多收集200分
            const scorePercentage = (score / 200) * 100;
            // 这里可以添加进度条的变化，如颜色变化
        }

        // 绘制HUD
        function drawHUD() {
            livesBar.style.width = `${(lives / 5) * 100}%`;
            livesBar.style.backgroundColor = (lives / 5) * 100 > 60 ? '#2ecc71' : (lives / 5) * 100 > 30 ? '#f1c40f' : '#e74c3c';
            timeBar.style.width = `${(timeLeft / 60) * 100}%`;
            timeBar.style.backgroundColor = (timeLeft / 60) * 100 > 50 ? '#00a8ff' : (timeLeft / 60) * 100 > 20 ? '#f39c12' : '#e74c3c';
        }

        // 游戏循环
        function gameLoop() {
            if (gameState !== 'playing') return;

            updateWithBoss();
            draw();
            drawHUD();
            animationId = requestAnimationFrame(gameLoop);
        }

        // 播放简单音效
        function playSound(frequency, type, duration) {
            if (!isSoundOn) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = type;
            oscillator.frequency.value = frequency;
            gainNode.gain.value = 0.1;

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duration / 1000);
        }

        // 初始化
        init();
    </script>
</body>
</html>
