<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>刺客信条 - HTML版 多关卡多目标+进阶版</title>
<style>
    /* 
    ================================
    刺客信条 HTML版 - 多关卡+赏金+数据保存+商店+优化UI+逻辑完善
    ================================
    修复点与优化：
    1. 修复点击关卡按钮无法正常开始游戏的问题：不再使用事件委托，给每个关卡按钮单独添加事件监听。
    2. 修复商店购买问题：不再使用inline onclick，在生成武器项目后为购买按钮添加事件监听，确保buyWeapon可用。
    3. 确保数据加载、保存、删除按钮正常工作，更新UI数据展示。
    4. 确保在游戏结束或返回关卡选择时清除名牌。
    5. 优化UI逻辑，关闭商店、数据管理面板后正确返回上一级界面。
    6. 各功能（商店购买、数据管理、关卡选择、数据保存加载）均经由事件监听器保证顺畅运行。
    7. 保留原逻辑基础上做出全面修复和优化。

    ================================
    */

    html, body {
        margin: 0;
        padding: 0;
        font-family: "Microsoft YaHei", sans-serif;
        background: #111;
        color: #ccc;
        height: 100%;
        overflow: hidden;
    }

    #game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(to bottom, #333, #111);
        overflow: hidden;
    }

    /* 启动画面 */
    #start-screen {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
    }

    #start-screen h1 {
        font-size: 3em;
        color: #eee;
        margin-bottom: 20px;
        text-shadow: 0 0 10px #fff;
    }

    #start-screen p {
        font-size: 1.2em;
        color: #aaa;
        margin-bottom: 40px;
        text-align: center;
        width: 60%;
        line-height: 1.6;
    }

    #start-screen button {
        background: #555;
        color: #eee;
        border: none;
        padding: 15px 30px;
        font-size: 1.2em;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
        margin: 10px;
    }

    #start-screen button:hover {
        background: #777;
    }

    /* 关卡选择界面 */
    #level-select-screen {
        position: absolute;
        top:0;left:0;right:0;bottom:0;
        background: rgba(0,0,0,0.8);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }

    #level-select-screen h2 {
        font-size: 2em;
        color: #eee;
        margin-bottom: 20px;
        text-shadow: 0 0 5px #fff;
    }

    #level-select-screen .levels {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
    }

    #level-select-screen .levels button {
        background: #555;
        color: #eee;
        border: none;
        padding: 10px 20px;
        font-size: 1.2em;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
        margin: 10px;
    }

    #level-select-screen .levels button:hover {
        background: #777;
    }

    #level-select-screen .difficulty {
        margin-top: 20px;
        display: flex;
        align-items: center;
    }

    #level-select-screen .difficulty span {
        margin-right: 10px;
    }

    #level-select-screen .difficulty select {
        background: #333;
        color: #eee;
        border: 1px solid #555;
        border-radius: 3px;
        padding: 5px;
    }

    /* 顶部HUD */
    #hud {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 50px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        padding: 0 20px;
        background: rgba(0,0,0,0.4);
        box-shadow: 0 0 10px #000;
    }

    #hud .left-hud, #hud .right-hud {
        display: flex;
        align-items: center;
    }

    #hud .left-hud .health-bar-container {
        position: relative;
        width: 200px;
        height: 20px;
        background: #333;
        border: 2px solid #555;
        margin-right: 20px;
        border-radius: 5px;
        overflow: hidden;
    }

    #hud .left-hud .health-bar {
        position: absolute;
        top: 0; left: 0;
        height: 100%;
        width: 100%;
        background: linear-gradient(to right, #8b0000, #ff0000);
        transition: width 0.3s;
    }

    #hud .left-hud .weapon-info {
        font-size: 1em;
        color: #eee;
        margin-right: 20px;
    }

    #hud .left-hud .mission-info {
        font-size: 1em;
        color: #eee;
        margin-right: 20px;
    }

    #hud .left-hud .gold-info {
        font-size: 1em;
        color: #ff0;
    }

    #hud .right-hud .mini-map {
        position: relative;
        width: 100px;
        height: 100px;
        background: #222;
        border: 2px solid #555;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #hud .right-hud .mini-map canvas {
        width: 100%;
        height: 100%;
    }

    /* 对话与提示框 */
    #dialog-box {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 50%;
        min-height: 100px;
        background: rgba(0,0,0,0.6);
        color: #eee;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px #000;
        display: none;
    }

    #dialog-box h2 {
        font-size: 1.4em;
        margin-bottom: 10px;
    }

    #dialog-box p {
        line-height: 1.6;
    }

    #dialog-box button {
        margin-top: 20px;
        background: #555;
        color: #eee;
        border: none;
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
    }

    #dialog-box button:hover {
        background: #777;
    }

    /* 游戏区 */
    #game-canvas {
        position: absolute;
        top: 50px;
        left: 0;
        width: 100%;
        height: calc(100% - 50px);
        background: #000;
        display: block;
        transition: background 1s;
    }

    /* 游戏结束屏幕 */
    #game-over-screen {
        position: absolute;
        top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        display: none;
    }

    #game-over-screen h1 {
        font-size: 3em;
        color: #eee;
        margin-bottom: 20px;
        text-shadow: 0 0 10px #f00;
    }

    #game-over-screen p {
        font-size: 1.4em;
        color: #ccc;
        margin-bottom: 40px;
        text-align: center;
        width: 60%;
        line-height: 1.6;
    }

    #game-over-screen button {
        background: #555;
        color: #eee;
        border: none;
        padding: 15px 30px;
        font-size: 1.2em;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
    }

    #game-over-screen button:hover {
        background: #777;
    }

    /* 胜利屏幕 */
    #victory-screen {
        position: absolute;
        top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        display: none;
    }

    #victory-screen h1 {
        font-size: 3em;
        color: #eee;
        margin-bottom: 20px;
        text-shadow: 0 0 10px #0f0;
    }

    #victory-screen p {
        font-size: 1.4em;
        color: #ccc;
        margin-bottom: 40px;
        text-align: center;
        width: 60%;
        line-height: 1.6;
    }

    #victory-screen button {
        background: #555;
        color: #eee;
        border: none;
        padding: 15px 30px;
        font-size: 1.2em;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
    }

    #victory-screen button:hover {
        background: #777;
    }

    /* 名字显示 */
    .name-label {
        position:absolute;
        background:rgba(0,0,0,0.7);
        color:#fff;
        padding:2px 5px;
        font-size:0.8em;
        border-radius:3px;
        pointer-events:none;
        transform:translate(-50%,-100%);
        white-space:nowrap;
        z-index:3000;
    }

    /* 商店面板 */
    #shop-screen {
        position: absolute;
        top:0;left:0;right:0;bottom:0;
        background: rgba(0,0,0,0.8);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1500;
    }

    #shop-screen h2 {
        font-size: 2em;
        color: #eee;
        margin-bottom: 20px;
    }

    #shop-screen .weapons {
        display: flex;
        flex-wrap: wrap;
        max-width: 600px;
        justify-content: center;
    }

    #shop-screen .weapon-item {
        background: #333;
        border: 2px solid #555;
        border-radius: 5px;
        padding: 10px;
        margin: 10px;
        text-align: center;
        color: #eee;
        width: 120px;
    }

    #shop-screen .weapon-item h3 {
        font-size: 1.2em;
        margin-bottom: 10px;
    }

    #shop-screen .weapon-item button {
        background: #555;
        border: none;
        color: #eee;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
    }

    #shop-screen .weapon-item button:hover {
        background: #777;
    }

    #shop-screen .bottom-buttons {
        margin-top:20px;
    }

    #shop-screen .bottom-buttons button {
        background: #555;
        color: #eee;
        border: none;
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
        margin: 10px;
    }

    #shop-screen .bottom-buttons button:hover {
        background: #777;
    }

    /* 数据管理面板 */
    #data-manage-screen {
        position: absolute;
        top:0;left:0;right:0;bottom:0;
        background: rgba(0,0,0,0.8);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1500;
    }

    #data-manage-screen h2 {
        font-size:2em;
        color:#eee;
        margin-bottom:20px;
    }

    #data-manage-screen p {
        font-size:1.2em;
        color:#ccc;
        margin-bottom:20px;
    }

    #data-manage-screen button {
        background: #555;
        color: #eee;
        border: none;
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
        margin: 10px;
    }

    #data-manage-screen button:hover {
        background: #777;
    }

</style>
</head>
<body>
<div id="game-container">
    <div id="start-screen">
        <h1>刺客信条 - HTML版</h1>
        <p>
            欢迎来到刺客的世界。使用WASD移动，空格键攻击。<br>
            有赏金目标可获得金币奖励，用金币可在商店购买更强武器。<br>
            你也可以保存/加载游戏数据（金币、武器、成就）。<br>
            准备好后点击开始进入关卡选择。<br><br>
            当前数据：<span id="start-gold-info"></span>
        </p>
        <button id="go-level-select">开始</button>
        <button id="go-data-manage">数据管理</button>
    </div>

    <div id="level-select-screen">
        <h2>选择关卡</h2>
        <div class="levels">
            <button id="select-city" data-level="city">城市</button>
            <button id="select-forest" data-level="forest">森林</button>
            <button id="select-fortress" data-level="fortress">堡垒</button>
        </div>
        <div class="difficulty">
            <span>选择难度：</span>
            <select id="difficulty-select">
                <option value="easy">容易</option>
                <option value="normal" selected>普通</option>
                <option value="hard">困难</option>
                <option value="extreme">极限</option>
            </select>
        </div>
        <button id="open-shop">进入商店</button>
        <button id="return-start">返回主菜单</button>
    </div>

    <div id="shop-screen">
        <h2>武器商店 (当前金币：<span id="shop-gold-info"></span>)</h2>
        <div class="weapons" id="shop-weapon-list">
            <!-- 动态生成武器列表 -->
        </div>
        <div class="bottom-buttons">
            <button id="close-shop">关闭商店</button>
        </div>
    </div>

    <div id="data-manage-screen">
        <h2>数据管理</h2>
        <p>在这里可以保存、加载或删除你的游戏数据（包括金币、已购武器、成就）。</p>
        <button id="save-data-button">保存数据</button>
        <button id="load-data-button">加载数据</button>
        <button id="delete-data-button">删除数据</button>
        <button id="close-data-manage">关闭</button>
    </div>

    <div id="hud">
        <div class="left-hud">
            <div class="health-bar-container">
                <div class="health-bar" id="health-bar"></div>
            </div>
            <div class="weapon-info" id="weapon-info">武器: 隐刃</div>
            <div class="mission-info" id="mission-info">任务: 未开始</div>
            <div class="gold-info" id="gold-info">金币: 0</div>
        </div>
        <div class="right-hud">
            <div class="mini-map">
                <canvas id="mini-map-canvas"></canvas>
            </div>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <div id="dialog-box">
        <h2 id="dialog-title"></h2>
        <p id="dialog-text"></p>
        <button id="dialog-button">继续</button>
    </div>

    <div id="game-over-screen">
        <h1>你已阵亡</h1>
        <p>很遗憾，你未能完成刺杀任务。请选择更适合你的难度与关卡重新开始。</p>
        <button id="retry-button">返回关卡选择</button>
    </div>

    <div id="victory-screen">
        <h1>任务完成！</h1>
        <p>恭喜你完成了主要目标的暗杀！你也获得了赏金目标的额外奖励。</p>
        <button id="victory-button">返回关卡选择</button>
    </div>

    <div id="name-label-container"></div>
</div>

<script>
/*
===================================
刺客信条 HTML版 多关卡+赏金+数据保存+商店+优化UI+逻辑完善
===================================

修复点和保证所有功能正常：
- 单独给每个关卡按钮添加事件监听，确保点击关卡按钮能正确开始游戏。
- 在刷新商店武器列表后为购买按钮动态添加事件监听，保证购买功能正常。
- 数据管理按钮正常工作，并更新UI。
- 游戏结束后返回关卡选择时清除名牌。
- 修复可能的UI显示问题，使流程更顺畅。

*/

var canvas = document.getElementById('game-canvas');
var ctx = canvas.getContext('2d');
var width = window.innerWidth;
var height = window.innerHeight - 50; 
canvas.width = width;
canvas.height = height;

var gameStarted = false;
var gameOver = false;
var victory = false;
var dialogActive = false;
var currentDialog = null;
var encounterTriggered = false;
var enemyKillCount = 0;
var currentLevel = null;
var difficulty = 'normal';
var firstTimeHint = true; 
var bountyTargets = [];
var bountyKillCount = 0;
var bountyReward = 50; // 每个赏金目标50金币

var player = {
    x: 200,
    y: 200,
    width: 40,
    height: 40,
    speed: 3,
    health: 100,
    maxHealth: 100,
    weapon: "隐刃",
    facing: "down",
    attacking: false,
    attackRange: 50,
    stealth: true
};

// 全局数据存储
var playerData = {
    gold: 0,
    ownedWeapons: ["隐刃"],
    achievements: {}
};

// 可购买的武器列表
var weaponShopItems = [
    {name:"长剑",cost:300},
    {name:"弓箭",cost:500},
    {name:"双刃",cost:1000}
];

var enemies = [];
var obstacles = [];
var decorations = [];
var assassinationTarget = { x: 1000, y: 600, width: 40, height: 40, alive: true, name: "主要目标" };
var mapWidth = 2000;
var mapHeight = 2000;
var cameraX = 0;
var cameraY = 0;
var keys = {};

var levelConfigs = {
    city: {
        mapWidth: 2000,
        mapHeight: 2000,
        baseEnemies: 20,
        target: {x:1000,y:600},
        bgColor: "#000",
        decorationType:"torch"
    },
    forest: {
        mapWidth: 3000,
        mapHeight: 3000,
        baseEnemies: 30,
        target: {x:1500,y:1500},
        bgColor: "#003300",
        decorationType:"tree"
    },
    fortress: {
        mapWidth: 1500,
        mapHeight: 1500,
        baseEnemies: 25,
        target: {x:700,y:700},
        bgColor: "#222",
        decorationType:"statue"
    }
};

var difficultyModifiers = {
    easy: {enemyFactor:0.8, visionFactor:0.9, playerRegen:true, enemyDamageFactor:0.9},
    normal:{enemyFactor:1.0, visionFactor:1.0, playerRegen:false, enemyDamageFactor:1.0},
    hard:{enemyFactor:1.1, visionFactor:1.1, playerRegen:false, enemyDamageFactor:1.2},
    extreme:{enemyFactor:1.2, visionFactor:1.3, playerRegen:false, enemyDamageFactor:1.5}
};

var dialogsLib = {
    city: [
        {id: "intro_city", title: "城市任务", text:"你来到了一座中世纪城市的中央广场。这里守卫众多，目标在广场中央。记住，暗杀赏金目标可获额外金币！", next:"hint_city"},
        {id: "hint_city", title: "提示", text:"WASD移动，空格攻击。利用建筑与阴影潜行。", next:null},
        {id: "victory", title: "任务完成", text:"你在城市中完成了暗杀！", next:null}
    ],
    forest: [
        {id: "intro_forest", title: "森林任务", text:"你深入幽暗森林，目标在森林深处。赏金目标潜伏其中，暗杀他们可获额外金币。", next:"hint_forest"},
        {id: "hint_forest", title: "提示", text:"WASD移动，空格攻击。利用树木躲避视线。", next:null},
        {id: "victory", title: "任务完成", text:"你在森林中成功完成刺杀！", next:null}
    ],
    fortress: [
        {id: "intro_fortress", title: "堡垒任务", text:"你潜入坚固堡垒。目标在大厅中，赏金目标也在此处潜伏。", next:"hint_fortress"},
        {id: "hint_fortress", title: "提示", text:"WASD移动，空格攻击。利用走廊和掩体。", next:null},
        {id: "victory", title: "任务完成", text:"你在堡垒中完成了艰难的刺杀！", next:null}
    ]
};
var currentDialogs = [];
var currentMission = "未开始";

function initGame() {
    var lc = levelConfigs[currentLevel];
    var dm = difficultyModifiers[difficulty];

    mapWidth = lc.mapWidth;
    mapHeight = lc.mapHeight;
    assassinationTarget.x = lc.target.x;
    assassinationTarget.y = lc.target.y;
    assassinationTarget.alive = true;

    enemies = [];
    obstacles = [];
    decorations = [];
    bountyTargets = [];
    bountyKillCount = 0;

    var enemyCount = Math.floor(lc.baseEnemies * dm.enemyFactor);
    initEnemies(enemyCount, dm);
    initObstacles(30);
    initDecorations(lc.decorationType, 20);
    initBountyTargets(7);

    document.getElementById("game-canvas").style.background = lc.bgColor;

    currentDialogs = dialogsLib[currentLevel].map(function(d){return Object.assign({},d);});
    showDialog("intro_"+currentLevel);

    currentMission = "前往目标区域";
    player.x = 200;
    player.y = 200;
    player.health = player.maxHealth;
    enemyKillCount = 0;
    encounterTriggered = false;
    gameOver = false;
    victory = false;

    setPlayerWeapon();

    updateHUD();
    gameStarted = true;
    gameLoop();
}

function setPlayerWeapon() {
    let weaponPrices = {"隐刃":0,"长剑":300,"弓箭":500,"双刃":1000};
    let maxCost = 0;
    let bestWeapon = "隐刃";
    playerData.ownedWeapons.forEach(w=>{
        let cost=weaponPrices[w]||0;
        if(cost>=maxCost){maxCost=cost;bestWeapon=w;}
    });
    player.weapon = bestWeapon;
}

function initEnemies(count, dm) {
    for (var i = 0; i < count; i++) {
        var visionRange = 200 * dm.visionFactor;
        var enemyDamage = 0.1 * dm.enemyDamageFactor;
        enemies.push({
            x: Math.random() * (mapWidth - 50) + 50,
            y: Math.random() * (mapHeight - 50) + 50,
            width: 40,
            height: 40,
            health: 50,
            maxHealth: 50,
            alive: true,
            patrolRoute: generatePatrolRoute(),
            currentPatrolIndex: 0,
            speed: 2,
            visionRange: visionRange,
            state: "patrol",
            facing: "down",
            damage: enemyDamage,
            name: "守卫"+(i+1)
        });
    }
}

function initObstacles(num) {
    obstacles = [];
    for (var i = 0; i < num; i++) {
        obstacles.push({
            x: Math.random() * (mapWidth - 100),
            y: Math.random() * (mapHeight - 100),
            width: 100,
            height: 100
        });
    }
}

function initDecorations(type, num) {
    for (var i=0; i<num; i++) {
        decorations.push({
            x:Math.random()*(mapWidth-50),
            y:Math.random()*(mapHeight-50),
            type:type
        });
    }
}

var bountyNames = ["Chris","Herman","张宸阳","王宇涵","杨嘉玉","张博彦","淇露"];
function initBountyTargets(num) {
    for(var i=0;i<num;i++){
        var name = bountyNames[i];
        bountyTargets.push({
            x: Math.random()*(mapWidth-50)+50,
            y: Math.random()*(mapHeight-50)+50,
            width:40,
            height:40,
            alive:true,
            name:name
        });
    }
}

function updateHUD() {
    var healthBar = document.getElementById("health-bar");
    var healthPercent = (player.health / player.maxHealth) * 100;
    healthBar.style.width = healthPercent + "%";
    document.getElementById("weapon-info").textContent = "武器: " + player.weapon;
    document.getElementById("mission-info").textContent = "任务: " + currentMission;
    document.getElementById("gold-info").textContent = "金币: " + playerData.gold;
}

function showDialog(id) {
    var d = currentDialogs.find(function(di){return di.id === id;});
    if(d) {
        if(d.id.startsWith("hint_") && !firstTimeHint) {
            hideDialog();
            return;
        }
        currentDialog = d;
        dialogActive = true;
        document.getElementById("dialog-title").textContent = d.title;
        document.getElementById("dialog-text").textContent = d.text;
        document.getElementById("dialog-box").style.display = "block";
    }
}

function hideDialog() {
    dialogActive = false;
    currentDialog = null;
    document.getElementById("dialog-box").style.display = "none";
}

function gameLoop() {
    if (!gameStarted || gameOver || victory) {
        requestAnimationFrame(gameLoop);
        return;
    }

    update();
    draw();
    requestAnimationFrame(gameLoop);
}

function update() {
    handleInput();
    updatePlayer();
    updateEnemies();
    checkCollisions();
    updateCamera();
    updateHUD();
    updateMissionStatus();
    updateMiniMap();
    checkEnemyKillMilestone();
    handlePlayerRegen();
}

function draw() {
    ctx.clearRect(0, 0, width, height);
    drawBackground();
    drawDecorations();
    obstacles.forEach(drawObstacle);

    if(assassinationTarget.alive) drawNamedEntity(assassinationTarget, "#a00","#f00");
    bountyTargets.forEach(function(bt){ if(bt.alive) drawNamedEntity(bt,"#aa0","#ff0"); });
    enemies.forEach(function(e){ if(e.alive) drawNamedEntity(e,"#008","#00f"); });
    drawPlayer(player);
}

function drawBackground() {
    ctx.save();
    ctx.translate(-cameraX, -cameraY);
    ctx.fillStyle = "#222";
    ctx.fillRect(0,0,mapWidth,mapHeight);
    ctx.strokeStyle = "#333";
    for (var x = 0; x < mapWidth; x += 100) {
        ctx.beginPath();
        ctx.moveTo(x,0);
        ctx.lineTo(x,mapHeight);
        ctx.stroke();
    }
    for (var y = 0; y < mapHeight; y += 100) {
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(mapWidth,y);
        ctx.stroke();
    }
    ctx.restore();
}

function drawObstacle(o) {
    ctx.save();
    ctx.translate(-cameraX, -cameraY);
    ctx.fillStyle = "#444";
    ctx.fillRect(o.x, o.y, o.width, o.height);
    ctx.strokeStyle = "#555";
    ctx.strokeRect(o.x, o.y, o.width, o.height);
    ctx.restore();
}

function drawDecorations() {
    ctx.save();
    ctx.translate(-cameraX, -cameraY);
    decorations.forEach(function(d){
        if(d.type==="tree"){
            ctx.fillStyle="#0c0";
            ctx.beginPath();
            ctx.arc(d.x,d.y,20,0,Math.PI*2);
            ctx.fill();
        } else if(d.type==="torch"){
            ctx.fillStyle="#c60";
            ctx.fillRect(d.x,d.y,10,30);
        } else if(d.type==="statue"){
            ctx.fillStyle="#999";
            ctx.fillRect(d.x,d.y,20,40);
        }
    });
    ctx.restore();
}

function drawNamedEntity(ent, fillColor, strokeColor) {
    ctx.save();
    ctx.translate(-cameraX, -cameraY);
    ctx.fillStyle = fillColor;
    ctx.fillRect(ent.x, ent.y, ent.width, ent.height);
    ctx.strokeStyle = strokeColor;
    ctx.strokeRect(ent.x, ent.y, ent.width, ent.height);
    ctx.restore();
    drawNameLabel(ent);
}

function drawPlayer(p) {
    ctx.save();
    ctx.translate(-cameraX, -cameraY);
    ctx.fillStyle = "#0f0";
    ctx.fillRect(p.x, p.y, p.width, p.height);
    ctx.strokeStyle = "#0c0";
    ctx.strokeRect(p.x, p.y, p.width, p.height);
    ctx.restore();
}

// 绘制名称标签
function drawNameLabel(ent) {
    if (!ent.name) return;
    var labelContainer = document.getElementById("name-label-container");
    var labelId = "label_" + ent.name.replace(/[^a-zA-Z0-9]/g,'_');
    var label = document.getElementById(labelId);
    if(!label) {
        label = document.createElement('div');
        label.id = labelId;
        label.className = 'name-label';
        labelContainer.appendChild(label);
    }
    label.textContent = ent.name;
    var screenX = ent.x - cameraX + ent.width/2;
    var screenY = ent.y - cameraY;
    label.style.left = screenX + "px";
    label.style.top = screenY + "px";
    if(!ent.alive) label.style.display = "none";
    else label.style.display = "block";
}

function clearNameLabels() {
    var labelContainer = document.getElementById("name-label-container");
    labelContainer.innerHTML = "";
}

function handleInput() {
    if (dialogActive) return;
    if (keys['w']) {player.y -= player.speed; player.facing = "up";}
    if (keys['s']) {player.y += player.speed; player.facing = "down";}
    if (keys['a']) {player.x -= player.speed; player.facing = "left";}
    if (keys['d']) {player.x += player.speed; player.facing = "right";}
}

function updatePlayer() {
    if (player.x < 0) player.x = 0;
    if (player.y < 0) player.y = 0;
    if (player.x + player.width > mapWidth) player.x = mapWidth - player.width;
    if (player.y + player.height > mapHeight) player.y = mapHeight - player.height;
    if (player.health <= 0 && !gameOver) triggerGameOver();
}

function updateEnemies() {
    enemies.forEach(function(e) {
        if (!e.alive) return;
        if (e.state === "patrol") {
            patrol(e);
            if (canSeePlayer(e)) e.state = "chase";
        } else if (e.state === "chase") {
            chase(e);
            if (!canSeePlayer(e)) e.state = "patrol";
        }
    });
}

function patrol(e) {
    var route = e.patrolRoute;
    if (route.length === 0) return;
    var target = route[e.currentPatrolIndex];
    var dx = target.x - e.x;
    var dy = target.y - e.y;
    var dist = Math.sqrt(dx*dx+dy*dy);
    if (dist < 10) {
        e.currentPatrolIndex = (e.currentPatrolIndex + 1) % route.length;
    } else {
        var angle = Math.atan2(dy, dx);
        e.x += Math.cos(angle)*e.speed;
        e.y += Math.sin(angle)*e.speed;
    }
}

function chase(e) {
    var dx = player.x - e.x;
    var dy = player.y - e.y;
    var dist = Math.sqrt(dx*dx+dy*dy);
    if (dist > 10) {
        var angle = Math.atan2(dy, dx);
        e.x += Math.cos(angle)*e.speed;
        e.y += Math.sin(angle)*e.speed;
    }
}

function canSeePlayer(e) {
    var dx = player.x - e.x;
    var dy = player.y - e.y;
    var dist = Math.sqrt(dx*dx+dy*dy);
    if (dist > e.visionRange) return false;
    return !isObstructed(e.x,e.y,player.x,player.y);
}

function isObstructed(x1,y1,x2,y2) {
    for (var i=0; i<obstacles.length; i++) {
        var o = obstacles[i];
        if (lineRectCollide(x1,y1,x2,y2,o.x,o.y,o.width,o.height)) return true;
    }
    return false;
}

function lineRectCollide(x1,y1,x2,y2,rx,ry,rw,rh) {
    if(lineLineCollide(x1,y1,x2,y2, rx,ry,rx,ry+rh)) return true;
    if(lineLineCollide(x1,y1,x2,y2, rx+rw,ry,rx+rw,ry+rh)) return true;
    if(lineLineCollide(x1,y1,x2,y2, rx,ry,rx+rw,ry)) return true;
    if(lineLineCollide(x1,y1,x2,y2, rx,ry+rh,rx+rw,ry+rh)) return true;
    if (x1 > rx && x1 < rx+rw && y1 > ry && y1 < ry+rh) return true;
    return false;
}

function lineLineCollide(x1,y1,x2,y2,x3,y3,x4,y4) {
    var uA = ((x4 - x3)*(y1 - y3) - (y4 - y3)*(x1 - x3)) /
             ((y4 - y3)*(x2 - x1) - (x4 - x3)*(y2 - y1));
    var uB = ((x2 - x1)*(y1 - y3) - (y2 - y1)*(x1 - x3)) /
             ((y4 - y3)*(x2 - x1) - (x4 - x3)*(y2 - y1));
    if (uA >= 0 && uA <= 1 && uB >= 0 && uB <= 1) return true;
    return false;
}

function checkCollisions() {
    obstacles.forEach(function(o) {
        if(rectCollide(player, o)) {
            resolvePlayerObstacleCollision(player, o);
        }
    });

    enemies.forEach(function(e) {
        if (e.alive && rectCollide(player, e)) {
            player.health -= e.damage;
        }
    });

    if (assassinationTarget.alive && rectCollide(player, assassinationTarget)) {
        if (player.attacking) {
            assassinationTarget.alive = false;
            showDialog("victory");
            setTimeout(function(){
                triggerVictory();
            },2000);
        }
    }

    if (player.attacking) {
        enemies.forEach(function(e) {
            if (e.alive && distance(player.x,player.y,e.x,e.y)<player.attackRange) {
                if (isBehindPlayer(e)) {
                    e.alive = false;
                    enemyKillCount++;
                    showRandomKillMessage();
                } else {
                    e.health -= 25;
                    if (e.health <=0) {
                        e.alive=false;
                        enemyKillCount++;
                        showRandomKillMessage();
                    }
                }
            }
        });

        bountyTargets.forEach(function(bt){
            if(bt.alive && distance(player.x,player.y,bt.x,bt.y)<player.attackRange){
                bt.alive=false;
                bountyKillCount++;
                playerData.gold += bountyReward;
                console.log("你暗杀了赏金目标：" + bt.name + " 获得"+bountyReward+"金币");
                saveGameData();
            }
        });
    }
}

function showRandomKillMessage() {
    var messages = [
        "你在阴影中解决了一个守卫。",
        "一击必杀！无声终结。",
        "敌人的血迹悄然消失于夜色。",
        "没有人会记得这个守卫的名字。"
    ];
    var msg = messages[Math.floor(Math.random()*messages.length)];
    console.log(msg);
}

function isBehindPlayer(e) {
    if (player.facing==="up" && e.y>player.y) return false;
    if (player.facing==="down" && e.y<player.y) return false;
    if (player.facing==="left" && e.x>player.x) return false;
    if (player.facing==="right" && e.x<player.x) return false;
    return true;
}

function distance(x1,y1,x2,y2) {
    var dx=x2-x1; var dy=y2-y1;
    return Math.sqrt(dx*dx+dy*dy);
}

function rectCollide(a,b) {
    return a.x < b.x+b.width && a.x+a.width > b.x && a.y < b.y+b.height && a.y+a.height > b.y;
}

function resolvePlayerObstacleCollision(p, o) {
    var playerCenterX = p.x+p.width/2;
    var playerCenterY = p.y+p.height/2;
    var obstacleCenterX = o.x+o.width/2;
    var obstacleCenterY = o.y+o.height/2;

    var dx = playerCenterX - obstacleCenterX;
    var dy = playerCenterY - obstacleCenterY;

    var combinedHalfWidth = (p.width+o.width)/2;
    var combinedHalfHeight= (p.height+o.height)/2;

    if(Math.abs(dx)<combinedHalfWidth && Math.abs(dy)<combinedHalfHeight) {
        var overlapX = combinedHalfWidth - Math.abs(dx);
        var overlapY = combinedHalfHeight - Math.abs(dy);

        if(overlapX<overlapY) {
            if(dx>0) p.x += overlapX; else p.x -= overlapX;
        } else {
            if(dy>0) p.y += overlapY; else p.y -= overlapY;
        }
    }
}

function updateCamera() {
    cameraX = player.x + player.width/2 - width/2;
    cameraY = player.y + player.height/2 - height/2;
    if (cameraX<0) cameraX=0;
    if (cameraY<0) cameraY=0;
    if (cameraX>mapWidth-width) cameraX=mapWidth-width;
    if (cameraY>mapHeight-height) cameraY=mapHeight-height;
}

function updateMissionStatus() {
    if (!assassinationTarget.alive) currentMission = "任务完成";
    else currentMission = "前往目标区域";
}

function updateMiniMap() {
    var mm = document.getElementById("mini-map-canvas");
    var mmCtx = mm.getContext('2d');
    mm.width = 100;
    mm.height = 100;

    mmCtx.fillStyle = "#222";
    mmCtx.fillRect(0,0,100,100);

    var scaleX = 100/mapWidth;
    var scaleY = 100/mapHeight;

    mmCtx.fillStyle = "#0f0";
    mmCtx.fillRect(player.x*scaleX, player.y*scaleY, 2, 2);

    if(assassinationTarget.alive) {
        mmCtx.fillStyle = "#f00";
        mmCtx.fillRect(assassinationTarget.x*scaleX, assassinationTarget.y*scaleY, 2, 2);
    }

    enemies.forEach(function(e) {
        if(e.alive){
            mmCtx.fillStyle="#00f";
            mmCtx.fillRect(e.x*scaleX, e.y*scaleY,2,2);
        }
    });

    bountyTargets.forEach(function(bt){
        if(bt.alive){
            mmCtx.fillStyle="#ff0";
            mmCtx.fillRect(bt.x*scaleX, bt.y*scaleY,2,2);
        }
    });
}

function checkEnemyKillMilestone() {
    if (enemyKillCount===5) console.log("你已击杀多名守卫，继续保持隐蔽。");
    if (enemyKillCount===10) console.log("你已如入无人之境，但仍需谨慎。");
}

function handlePlayerRegen() {
    if (difficulty === "easy" && player.health < player.maxHealth && !dialogActive && !gameOver && !victory) {
        if (Math.random()<0.01) { 
            player.health += 1; 
            if (player.health>player.maxHealth) player.health=player.maxHealth;
        }
    }
}

function triggerGameOver() {
    gameOver = true;
    document.getElementById("game-over-screen").style.display="flex";
}

function triggerVictory() {
    victory = true;
    saveGameData();
    document.getElementById("victory-screen").style.display="flex";
    console.log("你暗杀了"+bountyKillCount+"名赏金目标，总共获得"+(bountyKillCount*bountyReward)+"金币。");
}

function resetToLevelSelect() {
    gameOver = false;
    victory = false;
    gameStarted = false;
    document.getElementById("game-over-screen").style.display="none";
    document.getElementById("victory-screen").style.display="none";
    document.getElementById("level-select-screen").style.display="flex";
    clearNameLabels();
}

/* 数据存储相关函数 */
function saveGameData() {
    localStorage.setItem("assassin_game_data", JSON.stringify(playerData));
    console.log("数据已保存");
}

function loadGameData() {
    var data = localStorage.getItem("assassin_game_data");
    if(data) {
        playerData = JSON.parse(data);
        console.log("数据已加载", playerData);
    } else {
        console.log("没有找到存档数据");
    }
    updateUIDataDisplay();
}

function deleteGameData() {
    localStorage.removeItem("assassin_game_data");
    playerData = {gold:0,ownedWeapons:["隐刃"],achievements:{}};
    console.log("数据已删除");
    updateUIDataDisplay();
}

function updateUIDataDisplay() {
    document.getElementById("start-gold-info").textContent = playerData.gold+"金币";
    var shopGoldInfo = document.getElementById("shop-gold-info");
    if(shopGoldInfo) shopGoldInfo.textContent = playerData.gold;
    if(gameStarted) updateHUD();
}

function buyWeapon(weaponName, cost) {
    if(playerData.gold>=cost) {
        if(!playerData.ownedWeapons.includes(weaponName)) {
            playerData.ownedWeapons.push(weaponName);
        }
        playerData.gold -= cost;
        console.log("购买成功："+weaponName);
        saveGameData();
        updateUIDataDisplay();
        refreshShopWeaponList();
    } else {
        console.log("金币不足，无法购买！");
    }
}

function refreshShopWeaponList() {
    var shopList = document.getElementById("shop-weapon-list");
    shopList.innerHTML="";
    weaponShopItems.forEach(item=>{
        var div=document.createElement("div");
        div.className="weapon-item";
        div.innerHTML="<h3>"+item.name+"</h3><p>"+item.cost+"金币</p>";
        if(playerData.ownedWeapons.includes(item.name)){
            div.innerHTML+="<p>已拥有</p>";
        } else {
            let btn = document.createElement("button");
            btn.textContent="购买";
            btn.addEventListener("click",()=>buyWeapon(item.name,item.cost));
            div.appendChild(btn);
        }
        shopList.appendChild(div);
    });
}

// 关卡按钮事件
document.getElementById("select-city").addEventListener("click",function(){
    currentLevel = "city";
    difficulty = document.getElementById("difficulty-select").value;
    document.getElementById("level-select-screen").style.display="none";
    initGame();
});

document.getElementById("select-forest").addEventListener("click",function(){
    currentLevel = "forest";
    difficulty = document.getElementById("difficulty-select").value;
    document.getElementById("level-select-screen").style.display="none";
    initGame();
});

document.getElementById("select-fortress").addEventListener("click",function(){
    currentLevel = "fortress";
    difficulty = document.getElementById("difficulty-select").value;
    document.getElementById("level-select-screen").style.display="none";
    initGame();
});

document.getElementById("go-level-select").addEventListener("click", function(){
    document.getElementById("start-screen").style.display="none";
    document.getElementById("level-select-screen").style.display="flex";
});

document.getElementById("go-data-manage").addEventListener("click",function(){
    document.getElementById("data-manage-screen").style.display="flex";
});

document.getElementById("open-shop").addEventListener("click",function(){
    document.getElementById("shop-screen").style.display="flex";
    refreshShopWeaponList();
});

document.getElementById("close-shop").addEventListener("click",function(){
    document.getElementById("shop-screen").style.display="none";
});

document.getElementById("return-start").addEventListener("click",function(){
    document.getElementById("level-select-screen").style.display="none";
    document.getElementById("start-screen").style.display="flex";
    updateUIDataDisplay();
});

document.getElementById("dialog-button").addEventListener("click",function(){
    if (currentDialog && currentDialog.next) {
        var nextId = currentDialog.next;
        hideDialog();
        showDialog(nextId);
    } else {
        if(currentDialog && currentDialog.id.startsWith("hint_")) {
            firstTimeHint = false;
        }
        hideDialog();
    }
});

document.getElementById("retry-button").addEventListener("click", function(){
    resetToLevelSelect();
});

document.getElementById("victory-button").addEventListener("click", function(){
    resetToLevelSelect();
});

document.getElementById("save-data-button").addEventListener("click",function(){
    saveGameData();
});

document.getElementById("load-data-button").addEventListener("click",function(){
    loadGameData();
});

document.getElementById("delete-data-button").addEventListener("click",function(){
    deleteGameData();
});

document.getElementById("close-data-manage").addEventListener("click",function(){
    document.getElementById("data-manage-screen").style.display="none";
    updateUIDataDisplay();
});

document.addEventListener("keydown", function(e){
    keys[e.key.toLowerCase()] = true;
    if(e.key === " " && !dialogActive && !gameOver && !victory && gameStarted) {
        player.attacking = true;
        setTimeout(function(){
            player.attacking=false;
        },100);
    }
});
document.addEventListener("keyup", function(e){
    keys[e.key.toLowerCase()] = false;
});

window.addEventListener("resize", function(){
    width = window.innerWidth;
    height = window.innerHeight - 50;
    canvas.width = width;
    canvas.height = height;
});

function generatePatrolRoute() {
    var route = [];
    for (var j = 0; j < 4; j++) {
        route.push({
            x: Math.random() * mapWidth,
            y: Math.random() * mapHeight
        });
    }
    return route;
}

// 初始化时尝试加载数据
loadGameData();
updateUIDataDisplay();

</script>
</body>
</html>
