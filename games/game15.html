<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>猎杀Chris - 高级狙击手模拟游戏</title>
    <style>
        /* 基本样式 */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1e272e;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #ffffff;
        }
        #gameCanvas {
            display: block;
            background: #2f3640;
        }
        /* UI样式 */
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(47, 54, 64, 0.8);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: none;
        }
        .ui-element {
            margin: 8px 0;
            font-size: 18px;
        }
        #gameOverScreen, #missionCompleteScreen, #mainMenu, #leaderboardScreen, #chapterSelectScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 39, 46, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #ffffff;
            font-size: 32px;
            z-index: 20;
            display: none;
        }
        .menu-button {
            margin: 15px;
            padding: 15px 30px;
            font-size: 24px;
            background: #4cd137;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #ffffff;
            transition: background 0.3s;
        }
        .menu-button:hover {
            background: #44bd32;
        }
        /* Tooltip样式 */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 160px;
            background-color: #000000cc;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 30;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* Leaderboard样式 */
        #leaderboardList {
            text-align: left;
            max-width: 600px;
            width: 90%;
            margin-top: 20px;
        }
        #leaderboardList ul {
            list-style: none;
            padding: 0;
        }
        #leaderboardList li {
            padding: 8px 0;
            border-bottom: 1px solid #7f8c8d;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <!-- 主菜单 -->
    <div id="mainMenu">
        <h1>猎杀Chris</h1>
        <button class="menu-button" id="startGameButton">开始游戏</button>
        <button class="menu-button" id="chapterSelectButton">选择章节</button>
        <button class="menu-button" id="leaderboardButton">排行榜</button>
    </div>

    <!-- 章节选择 -->
    <div id="chapterSelectScreen">
        <h2>选择章节</h2>
        <div id="chapterButtonsContainer">
            <!-- 章节按钮将动态生成 -->
        </div>
        <button class="menu-button" id="backToMenuFromChapter">返回主菜单</button>
    </div>

    <!-- UI -->
    <div id="ui">
        <div class="ui-element">得分: <span id="score">0</span></div>
        <div class="ui-element">关卡: <span id="level">1</span></div>
        <div class="ui-element">章节: <span id="chapter">1</span></div>
        <div class="ui-element">时间: <span id="timer">120</span></div>
        <div class="ui-element tooltip">目标倍增
            <span class="tooltiptext">连续击中目标可获得分数倍增</span>
        </div>
    </div>

    <!-- 游戏结束界面 -->
    <div id="gameOverScreen">
        <div id="finalScore">任务失败！得分: 0</div>
        <button class="menu-button" id="restartButton">重新开始</button>
        <button class="menu-button" id="backToMenuFromGameOver">返回主菜单</button>
    </div>

    <!-- 任务完成界面 -->
    <div id="missionCompleteScreen">
        <div id="missionCompleteMessage">任务成功！进入下一关</div>
        <button class="menu-button" id="nextLevelButton">下一关</button>
        <button class="menu-button" id="backToMenuFromMissionComplete">返回主菜单</button>
    </div>

    <!-- 排行榜界面 -->
    <div id="leaderboardScreen">
        <h2>排行榜</h2>
        <div id="leaderboardList">
            <ul id="leaderboardEntries">
                <!-- 排行榜条目将动态生成 -->
            </ul>
        </div>
        <button class="menu-button" id="backToMenuFromLeaderboard">返回主菜单</button>
    </div>

    <script>
        // 获取画布和上下文
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 获取UI元素
        const ui = document.getElementById('ui');
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('lives'); // 移除生命显示，因为玩家只有一条生命
        const levelElement = document.getElementById('level');
        const chapterElement = document.getElementById('chapter');
        const timerElement = document.getElementById('timer');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const restartButton = document.getElementById('restartButton');
        const backToMenuFromGameOver = document.getElementById('backToMenuFromGameOver');
        const missionCompleteScreen = document.getElementById('missionCompleteScreen');
        const missionCompleteMessage = document.getElementById('missionCompleteMessage');
        const nextLevelButton = document.getElementById('nextLevelButton');
        const backToMenuFromMissionComplete = document.getElementById('backToMenuFromMissionComplete');
        const mainMenu = document.getElementById('mainMenu');
        const startGameButton = document.getElementById('startGameButton');
        const chapterSelectButton = document.getElementById('chapterSelectButton');
        const chapterSelectScreen = document.getElementById('chapterSelectScreen');
        const chapterButtonsContainer = document.getElementById('chapterButtonsContainer');
        const backToMenuFromChapter = document.getElementById('backToMenuFromChapter');
        const leaderboardButton = document.getElementById('leaderboardButton');
        const leaderboardScreen = document.getElementById('leaderboardScreen');
        const leaderboardEntries = document.getElementById('leaderboardEntries');
        const backToMenuFromLeaderboard = document.getElementById('backToMenuFromLeaderboard');

        // 设置画布大小
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 游戏变量
        let score = 0;
        let level = 1;
        let chapter = 1;
        let timeLeft = 120;
        let gameOver = false;
        let missionComplete = false;
        let civilians = [];
        let chris = null;
        let obstacles = [];
        let powerUps = [];
        let hitMultiplier = 1;
        let consecutiveHits = 0;
        let lastHitTime = 0;
        const multiplierResetTime = 5000; // 5秒内未击中则重置倍增
        let targetSpawnInterval = 1500; // 毫秒
        let lastSpawnTime = Date.now();
        let missionTimer = null;
        let explosions = [];
        let specialEvents = [];
        let activeSpecialEvent = null;

        // 定义章节配置
        const chaptersConfig = {
            1: {
                name: '森林突击',
                difficulty: '简单',
                time: 120,
                civilianCount: 10,
                specialFeatures: ['雨天'],
                uniqueChallenges: ['减少视野']
            },
            2: {
                name: '城市围攻',
                difficulty: '中等',
                time: 150,
                civilianCount: 15,
                specialFeatures: ['夜晚'],
                uniqueChallenges: ['移动速度加快']
            },
            3: {
                name: '沙漠风暴',
                difficulty: '困难',
                time: 180,
                civilianCount: 20,
                specialFeatures: ['沙尘暴'],
                uniqueChallenges: ['目标隐藏']
            }
            // 可以根据需要添加更多章节
        };

        // 类定义
        class Civilian {
            constructor() {
                this.size = 20;
                this.x = Math.random() * (canvas.width - 2 * this.size) + this.size;
                this.y = Math.random() * (canvas.height - 2 * this.size) + this.size;
                this.speed = Math.random() * 1 + 0.5 + chapter * 0.1;
                const angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(angle) * this.speed;
                this.vy = Math.sin(angle) * this.speed;
                this.color = '#2ecc71';
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                // 边界反弹
                if (this.x < this.size || this.x > canvas.width - this.size) {
                    this.vx *= -1;
                }
                if (this.y < this.size || this.y > canvas.height - this.size) {
                    this.vy *= -1;
                }

                // 避开障碍物
                obstacles.forEach(obstacle => {
                    if (isCollidingCircleRect(this, obstacle)) {
                        this.vx *= -1;
                        this.vy *= -1;
                    }
                });
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                // 绘制身体
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.closePath();

                // 绘制眼睛
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(-this.size / 4, -this.size / 4, this.size / 8, 0, Math.PI * 2);
                ctx.arc(this.size / 4, -this.size / 4, this.size / 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.closePath();

                // 绘制嘴巴
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, this.size / 8, this.size / 4, 0, Math.PI, false);
                ctx.stroke();
                ctx.closePath();

                ctx.restore();
            }
        }

        class Chris {
            constructor() {
                this.size = 30;
                this.x = Math.random() * (canvas.width - 2 * this.size) + this.size;
                this.y = Math.random() * (canvas.height - 2 * this.size) + this.size;
                this.speed = Math.random() * 1 + 0.5 + chapter * 0.2;
                const angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(angle) * this.speed;
                this.vy = Math.sin(angle) * this.speed;
                this.color = '#e74c3c';
                this.hidden = false; // 是否隐藏
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                // 边界反弹
                if (this.x < this.size || this.x > canvas.width - this.size) {
                    this.vx *= -1;
                }
                if (this.y < this.size || this.y > canvas.height - this.size) {
                    this.vy *= -1;
                }

                // 避开障碍物
                obstacles.forEach(obstacle => {
                    if (isCollidingCircleRect(this, obstacle)) {
                        this.vx *= -1;
                        this.vy *= -1;
                    }
                });
            }

            draw() {
                if (this.hidden) return; // 如果隐藏则不绘制
                ctx.save();
                ctx.translate(this.x, this.y);
                // 绘制身体
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.closePath();

                // 绘制眼睛
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(-this.size / 3, -this.size / 3, this.size / 10, 0, Math.PI * 2);
                ctx.arc(this.size / 3, -this.size / 3, this.size / 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.closePath();

                // 绘制嘴巴
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(-this.size / 3, this.size / 4);
                ctx.lineTo(this.size / 3, this.size / 4);
                ctx.stroke();
                ctx.closePath();

                // 绘制帽子
                ctx.fillStyle = '#34495e';
                ctx.beginPath();
                ctx.arc(0, -this.size, this.size, Math.PI, 0, false);
                ctx.fill();
                ctx.closePath();

                ctx.restore();
            }
        }

        class Obstacle {
            constructor(x, y, width, height) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = '#7f8c8d';
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        class Explosion {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = 0;
                this.maxRadius = 50;
                this.alpha = 1;
            }

            update() {
                this.radius += 3;
                this.alpha -= 0.02;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#f39c12';
                ctx.fill();
                ctx.closePath();
                ctx.restore();
            }

            isDone() {
                return this.alpha <= 0;
            }
        }

        class PowerUp {
            constructor(type) {
                this.type = type; // 'multiplier' 或 'slow'
                this.size = 25;
                this.x = Math.random() * (canvas.width - 2 * this.size) + this.size;
                this.y = Math.random() * (canvas.height - 2 * this.size) + this.size;
                this.speed = 0.5;
                const angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(angle) * this.speed;
                this.vy = Math.sin(angle) * this.speed;
                this.color = type === 'multiplier' ? '#f1c40f' : '#3498db';
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                // 边界反弹
                if (this.x < this.size || this.x > canvas.width - this.size) {
                    this.vx *= -1;
                }
                if (this.y < this.size || this.y > canvas.height - this.size) {
                    this.vy *= -1;
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.closePath();

                // 绘制图标
                ctx.fillStyle = '#ffffff';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                if (this.type === 'multiplier') {
                    ctx.fillText('x2', 0, 0);
                } else if (this.type === 'slow') {
                    ctx.fillText('S', 0, 0);
                }
                ctx.restore();
            }
        }

        // 初始化障碍物
        function initObstacles() {
            obstacles = [];
            // 随章节增加障碍物数量
            const numObstacles = 3 + chapter;
            for (let i = 0; i < numObstacles; i++) {
                const width = 100;
                const height = 20;
                const x = Math.random() * (canvas.width - width * 2) + width;
                const y = Math.random() * (canvas.height - height * 2) + height;
                obstacles.push(new Obstacle(x, y, width, height));
            }
        }

        // 生成平民
        function spawnCivilians(count) {
            for (let i = 0; i < count; i++) {
                civilians.push(new Civilian());
            }
        }

        // 生成Chris
        function spawnChris() {
            chris = new Chris();
        }

        // 检查圆形与矩形碰撞
        function isCollidingCircleRect(circle, rect) {
            const distX = Math.abs(circle.x - rect.x - rect.width / 2);
            const distY = Math.abs(circle.y - rect.y - rect.height / 2);

            if (distX > (rect.width / 2 + circle.size)) { return false; }
            if (distY > (rect.height / 2 + circle.size)) { return false; }

            if (distX <= (rect.width / 2)) { return true; }
            if (distY <= (rect.height / 2)) { return true; }

            const dx = distX - rect.width / 2;
            const dy = distY - rect.height / 2;
            return (dx * dx + dy * dy <= (circle.size * circle.size));
        }

        // 绘制背景
        function drawBackground() {
            // 绘制天空
            ctx.fillStyle = '#2980b9';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 绘制地面
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);

            // 绘制简单的山脉
            ctx.fillStyle = '#34495e';
            ctx.beginPath();
            ctx.moveTo(0, canvas.height - 100);
            ctx.lineTo(canvas.width * 0.25, canvas.height - 300);
            ctx.lineTo(canvas.width * 0.5, canvas.height - 100);
            ctx.closePath();
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(canvas.width * 0.5, canvas.height - 100);
            ctx.lineTo(canvas.width * 0.75, canvas.height - 250);
            ctx.lineTo(canvas.width, canvas.height - 100);
            ctx.closePath();
            ctx.fill();

            // 根据章节的特殊功能绘制
            const currentChapter = chaptersConfig[chapter];
            if (currentChapter.specialFeatures.includes('雨天')) {
                drawRain();
            }
            if (currentChapter.specialFeatures.includes('沙尘暴')) {
                drawDustStorm();
            }
            if (currentChapter.specialFeatures.includes('夜晚')) {
                drawNightOverlay();
            }
        }

        // 绘制雨天效果
        function drawRain() {
            ctx.fillStyle = 'rgba(173,216,230,0.5)';
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const length = Math.random() * 20 + 10;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + 2, y + length);
                ctx.strokeStyle = '#87CEEB';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        // 绘制沙尘暴效果
        function drawDustStorm() {
            ctx.fillStyle = 'rgba(210,180,140,0.3)';
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 5;
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.closePath();
            }
        }

        // 绘制夜晚效果
        function drawNightOverlay() {
            ctx.fillStyle = 'rgba(25,25,112,0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawStars();
        }

        // 绘制星星
        function drawStars() {
            ctx.fillStyle = '#fffacd';
            for (let i = 0; i < 50; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * (canvas.height - 100); // 避免覆盖地面
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.closePath();
            }
        }

        // 绘制十字准星
        function drawCrosshair(x, y) {
            const size = 30;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            // 横线
            ctx.beginPath();
            ctx.moveTo(x - size, y);
            ctx.lineTo(x + size, y);
            ctx.stroke();
            // 竖线
            ctx.beginPath();
            ctx.moveTo(x, y - size);
            ctx.lineTo(x, y + size);
            ctx.stroke();
            // 圆圈
            ctx.beginPath();
            ctx.arc(x, y, size / 2, 0, Math.PI * 2);
            ctx.stroke();
            ctx.closePath();
        }

        // 鼠标位置
        let crosshair = {x: canvas.width / 2, y: canvas.height / 2};
        canvas.addEventListener('mousemove', function(e) {
            crosshair.x = e.clientX;
            crosshair.y = e.clientY;
        });

        // 点击射击
        canvas.addEventListener('click', function(e) {
            if (gameOver || missionComplete) return;
            const clickX = e.clientX;
            const clickY = e.clientY;
            let hit = false;

            // 检测Chris是否被击中
            if (chris) {
                const distanceChris = Math.hypot(chris.x - clickX, chris.y - clickY);
                if (distanceChris <= chris.size) {
                    hit = true;
                    score += 100 * hitMultiplier;
                    scoreElement.textContent = score;
                    explosions.push(new Explosion(chris.x, chris.y));
                    addToLeaderboard(score);
                    missionComplete = true;
                    showMissionComplete();
                    return;
                }
            }

            // 检测平民是否被击中
            civilians.forEach((civilian, index) => {
                const distance = Math.hypot(civilian.x - clickX, civilian.y - clickY);
                if (distance <= civilian.size) {
                    hit = true;
                    explosions.push(new Explosion(civilian.x, civilian.y));
                    addToLeaderboard(score);
                    endGame();
                }
            });

            if (hit) {
                // 播放击中特效
                consecutiveHits++;
                if (Date.now() - lastHitTime < multiplierResetTime) {
                    hitMultiplier = Math.min(hitMultiplier + 1, 5); // 最大倍增5倍
                } else {
                    hitMultiplier = 2;
                }
                lastHitTime = Date.now();

                // 连续击中达到一定数量时生成道具
                if (consecutiveHits % 5 === 0) {
                    spawnPowerUp();
                }
            } else {
                // 如果没有击中任何目标，降低连击
                consecutiveHits = 0;
                hitMultiplier = 1;
            }
        });

        // 生成道具
        function spawnPowerUp() {
            const rand = Math.random();
            const type = rand < 0.5 ? 'multiplier' : 'slow';
            powerUps.push(new PowerUp(type));
        }

        // 结束游戏
        function endGame() {
            gameOver = true;
            clearInterval(missionTimer);
            finalScoreElement.textContent = '任务失败！得分: ' + score;
            gameOverScreen.style.display = 'flex';
        }

        // 任务完成，进入下一关
        function showMissionComplete() {
            clearInterval(missionTimer);
            missionCompleteMessage.textContent = `任务成功！得分: ${score}`;
            missionCompleteScreen.style.display = 'flex';
        }

        // 重新开始
        restartButton.addEventListener('click', function() {
            resetGame();
        });

        // 返回主菜单
        backToMenuFromGameOver.addEventListener('click', function() {
            resetGame();
            showMainMenu();
        });

        backToMenuFromMissionComplete.addEventListener('click', function() {
            resetGame();
            showMainMenu();
        });

        // 进入下一关
        nextLevelButton.addEventListener('click', function() {
            level++;
            resetLevel();
        });

        // 进入主菜单
        function showMainMenu() {
            ui.style.display = 'none';
            gameOverScreen.style.display = 'none';
            missionCompleteScreen.style.display = 'none';
            leaderboardScreen.style.display = 'none';
            chapterSelectScreen.style.display = 'none';
            mainMenu.style.display = 'flex';
        }

        // 进入章节选择
        chapterSelectButton.addEventListener('click', function() {
            mainMenu.style.display = 'none';
            chapterSelectScreen.style.display = 'flex';
        });

        backToMenuFromChapter.addEventListener('click', function() {
            chapterSelectScreen.style.display = 'none';
            showMainMenu();
        });

        // 生成章节按钮
        function generateChapterButtons() {
            chapterButtonsContainer.innerHTML = '';
            for (let chap in chaptersConfig) {
                const btn = document.createElement('button');
                btn.classList.add('menu-button');
                btn.textContent = `章节 ${chap}: ${chaptersConfig[chap].name}`;
                btn.addEventListener('click', function() {
                    chapter = parseInt(chap);
                    startChapter();
                });
                chapterButtonsContainer.appendChild(btn);
            }
        }

        // 开始章节
        function startChapter() {
            mainMenu.style.display = 'none';
            chapterSelectScreen.style.display = 'none';
            initChapter();
        }

        // 初始化章节
        function initChapter() {
            score = 0;
            level = 1;
            timeLeft = chaptersConfig[chapter].time;
            gameOver = false;
            missionComplete = false;
            civilians = [];
            chris = null;
            obstacles = [];
            powerUps = [];
            hitMultiplier = 1;
            consecutiveHits = 0;
            lastHitTime = 0;
            targetSpawnInterval = 1500;
            lastSpawnTime = Date.now();
            explosions = [];
            specialEvents = [];
            activeSpecialEvent = null;

            ui.style.display = 'block';
            mainMenu.style.display = 'none';
            gameOverScreen.style.display = 'none';
            missionCompleteScreen.style.display = 'none';

            // 更新UI
            scoreElement.textContent = score;
            levelElement.textContent = level;
            chapterElement.textContent = `章节 ${chapter}: ${chaptersConfig[chapter].name}`;
            timerElement.textContent = timeLeft;

            // 初始化障碍物
            initObstacles();

            // 生成平民
            spawnCivilians(chaptersConfig[chapter].civilianCount);

            // 生成Chris
            spawnChris();

            // 开始计时器
            startTimer();

            // 开始游戏循环
            gameLoop();
        }

        // 重置游戏
        function resetGame() {
            score = 0;
            level = 1;
            chapter = 1;
            timeLeft = 120;
            gameOver = false;
            missionComplete = false;
            civilians = [];
            chris = null;
            obstacles = [];
            powerUps = [];
            hitMultiplier = 1;
            consecutiveHits = 0;
            lastHitTime = 0;
            targetSpawnInterval = 1500;
            lastSpawnTime = Date.now();
            explosions = [];
            specialEvents = [];
            activeSpecialEvent = null;

            ui.style.display = 'none';
            gameOverScreen.style.display = 'none';
            missionCompleteScreen.style.display = 'none';
            leaderboardScreen.style.display = 'none';
            chapterSelectScreen.style.display = 'none';
            mainMenu.style.display = 'flex';
        }

        // 重置关卡
        function resetLevel() {
            timeLeft = chaptersConfig[chapter].time;
            missionComplete = false;
            civilians = [];
            chris = null;
            obstacles = [];
            powerUps = [];
            explosions = [];

            // 根据章节配置初始化障碍物
            initObstacles();

            // 生成平民
            spawnCivilians(chaptersConfig[chapter].civilianCount + level * 2);

            // 生成Chris
            spawnChris();

            // 更新UI
            levelElement.textContent = level;
            timerElement.textContent = timeLeft;

            // 开始计时器
            startTimer();

            // 开始游戏循环
            gameLoop();
        }

        // 添加到排行榜
        function addToLeaderboard(newScore) {
            let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
            leaderboard.push({score: newScore, date: new Date().toLocaleString()});
            // 按分数降序排序
            leaderboard.sort((a, b) => b.score - a.score);
            // 保留前10名
            leaderboard = leaderboard.slice(0, 10);
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
        }

        // 显示排行榜
        function showLeaderboard() {
            leaderboardEntries.innerHTML = '';
            let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
            if (leaderboard.length === 0) {
                leaderboardEntries.innerHTML = '<li>暂无记录</li>';
            } else {
                leaderboard.forEach((entry, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${index + 1}. 分数: ${entry.score} - 时间: ${entry.date}`;
                    leaderboardEntries.appendChild(li);
                });
            }
            mainMenu.style.display = 'none';
            leaderboardScreen.style.display = 'flex';
        }

        leaderboardButton.addEventListener('click', function() {
            showLeaderboard();
        });

        backToMenuFromLeaderboard.addEventListener('click', function() {
            leaderboardScreen.style.display = 'none';
            showMainMenu();
        });

        // 碰撞检测辅助函数（重复定义，保留一个）
        // function isCollidingCircleRect(circle, rect) {
        //     // 已定义上方
        // }

        // 绘制特殊事件
        function handleSpecialEvents() {
            if (activeSpecialEvent) {
                // 根据特殊事件类型执行不同的效果
                if (activeSpecialEvent.type === '临时障碍') {
                    // 例如，临时生成一个障碍物
                    obstacles.push(new Obstacle(activeSpecialEvent.x, activeSpecialEvent.y, activeSpecialEvent.width, activeSpecialEvent.height));
                }
                // 可以添加更多特殊事件类型
            }
        }

        // 生成随机特殊事件
        function generateSpecialEvent() {
            const rand = Math.random();
            if (rand < 0.05) { // 5%的概率触发特殊事件
                const eventTypes = ['临时障碍', '目标加速'];
                const type = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                if (type === '临时障碍') {
                    const tempObstacle = {
                        type: '临时障碍',
                        x: Math.random() * (canvas.width - 100) + 50,
                        y: Math.random() * (canvas.height - 100) + 50,
                        width: 100,
                        height: 20,
                        duration: 5000 // 持续5秒
                    };
                    specialEvents.push(tempObstacle);
                }
                // 可以添加更多特殊事件配置
            }
        }

        // 处理特殊事件
        function processSpecialEvents() {
            specialEvents.forEach((event, index) => {
                if (!event.startTime) {
                    event.startTime = Date.now();
                    handleSpecialEvents();
                }
                if (Date.now() - event.startTime > event.duration) {
                    // 移除临时障碍物
                    if (event.type === '临时障碍') {
                        obstacles = obstacles.filter(ob => ob.x !== event.x || ob.y !== event.y);
                    }
                    specialEvents.splice(index, 1);
                }
            });
        }

        // 游戏主循环
        function gameLoop() {
            if (!gameOver && !missionComplete) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 绘制背景
                drawBackground();

                // 绘制障碍物
                obstacles.forEach(obstacle => obstacle.draw());

                // 更新和绘制平民
                civilians.forEach(civilian => {
                    civilian.update();
                    civilian.draw();
                });

                // 更新和绘制Chris
                if (chris) {
                    // 根据章节的独特挑战调整Chris
                    if (chaptersConfig[chapter].uniqueChallenges.includes('目标隐藏') && Math.random() < 0.01) {
                        chris.hidden = true;
                        setTimeout(() => {
                            chris.hidden = false;
                        }, 3000); // 隐藏3秒
                    }
                    chris.update();
                    chris.draw();
                }

                // 更新和绘制道具
                powerUps.forEach((powerUp, index) => {
                    powerUp.update();
                    powerUp.draw();
                });

                // 更新和绘制爆炸
                explosions.forEach((explosion, index) => {
                    explosion.update();
                    explosion.draw();
                    if (explosion.isDone()) {
                        explosions.splice(index, 1);
                    }
                });

                // 处理和绘制特殊事件
                processSpecialEvents();

                // 绘制准星
                drawCrosshair(crosshair.x, crosshair.y);

                // 检查倍增器是否需要重置
                if (hitMultiplier > 1 && Date.now() - lastHitTime > multiplierResetTime) {
                    hitMultiplier = 1;
                }

                // 生成随机特殊事件
                generateSpecialEvent();

                requestAnimationFrame(gameLoop);
            }
        }

        // 开始计时器
        function startTimer() {
            missionTimer = setInterval(function() {
                if (timeLeft > 0) {
                    timeLeft--;
                    timerElement.textContent = timeLeft;
                } else {
                    clearInterval(missionTimer);
                    addToLeaderboard(score);
                    endGame();
                }
            }, 1000);
        }

        // 游戏初始化
        function initGame() {
            score = 0;
            level = 1;
            timeLeft = chaptersConfig[chapter].time;
            gameOver = false;
            missionComplete = false;
            civilians = [];
            chris = null;
            obstacles = [];
            powerUps = [];
            hitMultiplier = 1;
            consecutiveHits = 0;
            lastHitTime = 0;
            targetSpawnInterval = 1500;
            lastSpawnTime = Date.now();
            explosions = [];
            specialEvents = [];
            activeSpecialEvent = null;

            ui.style.display = 'block';
            mainMenu.style.display = 'none';
            gameOverScreen.style.display = 'none';
            missionCompleteScreen.style.display = 'none';
            leaderboardScreen.style.display = 'none';
            chapterSelectScreen.style.display = 'none';

            // 更新UI
            scoreElement.textContent = score;
            levelElement.textContent = level;
            chapterElement.textContent = `章节 ${chapter}: ${chaptersConfig[chapter].name}`;
            timerElement.textContent = timeLeft;

            // 初始化障碍物
            initObstacles();

            // 生成平民
            spawnCivilians(chaptersConfig[chapter].civilianCount);

            // 生成Chris
            spawnChris();

            // 开始计时器
            startTimer();

            // 开始游戏循环
            gameLoop();
        }

        // 生成下一关的配置
        function nextLevelConfig() {
            level++;
            // 根据关卡数调整难度
            // 例如，每提升5关增加章节
            if (level % 5 === 0 && chapter < Object.keys(chaptersConfig).length) {
                chapter++;
                level = 1;
                initChapter();
                return;
            }

            // 增加平民数量和速度
            spawnCivilians(5);
        }

        // 重新开始游戏
        restartButton.addEventListener('click', function() {
            resetGame();
        });

        // 返回主菜单按钮
        backToMenuFromLeaderboard.addEventListener('click', function() {
            leaderboardScreen.style.display = 'none';
            showMainMenu();
        });

        backToMenuFromChapter.addEventListener('click', function() {
            chapterSelectScreen.style.display = 'none';
            showMainMenu();
        });

        // 进入下一关
        nextLevelButton.addEventListener('click', function() {
            missionCompleteScreen.style.display = 'none';
            nextLevel();
        });

        // 进入下一关函数
        function nextLevel() {
            level++;
            // 根据章节的独特挑战调整游戏
            resetLevel();
        }

        // 显示主菜单
        function showMainMenu() {
            ui.style.display = 'none';
            gameOverScreen.style.display = 'none';
            missionCompleteScreen.style.display = 'none';
            leaderboardScreen.style.display = 'none';
            chapterSelectScreen.style.display = 'none';
            mainMenu.style.display = 'flex';
        }

        // 选择章节按钮事件
        chapterSelectButton.addEventListener('click', function() {
            mainMenu.style.display = 'none';
            chapterSelectScreen.style.display = 'flex';
        });

        // 开始游戏按钮事件（默认选择第一个章节）
        startGameButton.addEventListener('click', function() {
            mainMenu.style.display = 'none';
            chapterSelectScreen.style.display = 'flex';
        });

        // 生成章节按钮
        generateChapterButtons();

        // 生成章节按钮函数
        function generateChapterButtons() {
            chapterButtonsContainer.innerHTML = '';
            for (let chap in chaptersConfig) {
                const btn = document.createElement('button');
                btn.classList.add('menu-button');
                btn.textContent = `章节 ${chap}: ${chaptersConfig[chap].name}`;
                btn.addEventListener('click', function() {
                    chapter = parseInt(chap);
                    chapterSelectScreen.style.display = 'none';
                    initChapter();
                });
                chapterButtonsContainer.appendChild(btn);
            }
        }

        // 初始化章节
        function initChapter() {
            score = 0;
            level = 1;
            timeLeft = chaptersConfig[chapter].time;
            gameOver = false;
            missionComplete = false;
            civilians = [];
            chris = null;
            obstacles = [];
            powerUps = [];
            hitMultiplier = 1;
            consecutiveHits = 0;
            lastHitTime = 0;
            targetSpawnInterval = 1500;
            lastSpawnTime = Date.now();
            explosions = [];
            specialEvents = [];
            activeSpecialEvent = null;

            ui.style.display = 'block';
            mainMenu.style.display = 'none';
            gameOverScreen.style.display = 'none';
            missionCompleteScreen.style.display = 'none';
            leaderboardScreen.style.display = 'none';
            chapterSelectScreen.style.display = 'none';

            // 更新UI
            scoreElement.textContent = score;
            levelElement.textContent = level;
            chapterElement.textContent = `章节 ${chapter}: ${chaptersConfig[chapter].name}`;
            timerElement.textContent = timeLeft;

            // 初始化障碍物
            initObstacles();

            // 生成平民
            spawnCivilians(chaptersConfig[chapter].civilianCount);

            // 生成Chris
            spawnChris();

            // 开始计时器
            startTimer();

            // 开始游戏循环
            gameLoop();
        }

        // 游戏循环启动
        // initGame();

        // 绘制章节名称
        // 可以在UI中添加章节名称显示

        // 显示排行榜
        function showLeaderboard() {
            leaderboardEntries.innerHTML = '';
            let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
            if (leaderboard.length === 0) {
                leaderboardEntries.innerHTML = '<li>暂无记录</li>';
            } else {
                leaderboard.forEach((entry, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${index + 1}. 分数: ${entry.score} - 时间: ${entry.date}`;
                    leaderboardEntries.appendChild(li);
                });
            }
            mainMenu.style.display = 'none';
            leaderboardScreen.style.display = 'flex';
        }

        // 添加到排行榜
        function addToLeaderboard(newScore) {
            let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
            leaderboard.push({score: newScore, date: new Date().toLocaleString()});
            // 按分数降序排序
            leaderboard.sort((a, b) => b.score - a.score);
            // 保留前10名
            leaderboard = leaderboard.slice(0, 10);
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
        }

        // 处理特殊事件
        function processSpecialEvents() {
            specialEvents.forEach((event, index) => {
                if (!event.startTime) {
                    event.startTime = Date.now();
                    handleSpecialEvents(event);
                }
                if (Date.now() - event.startTime > event.duration) {
                    // 移除临时障碍物
                    if (event.type === '临时障碍') {
                        obstacles = obstacles.filter(ob => ob.x !== event.x || ob.y !== event.y);
                    }
                    specialEvents.splice(index, 1);
                }
            });
        }

        // 绘制特殊事件
        function handleSpecialEvents(event) {
            if (event.type === '临时障碍') {
                // 例如，临时生成一个障碍物
                obstacles.push(new Obstacle(event.x, event.y, event.width, event.height));
            }
            // 可以添加更多特殊事件类型
        }

        // 生成随机特殊事件
        function generateSpecialEvent() {
            const rand = Math.random();
            if (rand < 0.05) { // 5%的概率触发特殊事件
                const eventTypes = ['临时障碍', '目标加速'];
                const type = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                if (type === '临时障碍') {
                    const tempObstacle = {
                        type: '临时障碍',
                        x: Math.random() * (canvas.width - 100) + 50,
                        y: Math.random() * (canvas.height - 100) + 50,
                        width: 100,
                        height: 20,
                        duration: 5000 // 持续5秒
                    };
                    specialEvents.push(tempObstacle);
                }
                // 可以添加更多特殊事件配置
            }
        }

        // 游戏主循环
        function gameLoop() {
            if (!gameOver && !missionComplete) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 绘制背景
                drawBackground();

                // 绘制障碍物
                obstacles.forEach(obstacle => obstacle.draw());

                // 更新和绘制平民
                civilians.forEach(civilian => {
                    civilian.update();
                    civilian.draw();
                });

                // 更新和绘制Chris
                if (chris) {
                    // 根据章节的独特挑战调整Chris
                    if (chaptersConfig[chapter].uniqueChallenges.includes('目标隐藏') && Math.random() < 0.01) {
                        chris.hidden = true;
                        setTimeout(() => {
                            chris.hidden = false;
                        }, 3000); // 隐藏3秒
                    }
                    chris.update();
                    chris.draw();
                }

                // 更新和绘制道具
                powerUps.forEach((powerUp, index) => {
                    powerUp.update();
                    powerUp.draw();
                });

                // 更新和绘制爆炸
                explosions.forEach((explosion, index) => {
                    explosion.update();
                    explosion.draw();
                    if (explosion.isDone()) {
                        explosions.splice(index, 1);
                    }
                });

                // 处理和绘制特殊事件
                processSpecialEvents();

                // 绘制准星
                drawCrosshair(crosshair.x, crosshair.y);

                // 检查倍增器是否需要重置
                if (hitMultiplier > 1 && Date.now() - lastHitTime > multiplierResetTime) {
                    hitMultiplier = 1;
                }

                // 生成随机特殊事件
                generateSpecialEvent();

                requestAnimationFrame(gameLoop);
            }
        }

        // 初始化章节
        function initChapter() {
            score = 0;
            level = 1;
            timeLeft = chaptersConfig[chapter].time;
            gameOver = false;
            missionComplete = false;
            civilians = [];
            chris = null;
            obstacles = [];
            powerUps = [];
            hitMultiplier = 1;
            consecutiveHits = 0;
            lastHitTime = 0;
            targetSpawnInterval = 1500;
            lastSpawnTime = Date.now();
            explosions = [];
            specialEvents = [];
            activeSpecialEvent = null;

            ui.style.display = 'block';
            mainMenu.style.display = 'none';
            gameOverScreen.style.display = 'none';
            missionCompleteScreen.style.display = 'none';
            leaderboardScreen.style.display = 'none';
            chapterSelectScreen.style.display = 'none';

            // 更新UI
            scoreElement.textContent = score;
            levelElement.textContent = level;
            chapterElement.textContent = `章节 ${chapter}: ${chaptersConfig[chapter].name}`;
            timerElement.textContent = timeLeft;

            // 初始化障碍物
            initObstacles();

            // 生成平民
            spawnCivilians(chaptersConfig[chapter].civilianCount);

            // 生成Chris
            spawnChris();

            // 开始计时器
            startTimer();

            // 开始游戏循环
            gameLoop();
        }

        // 开始游戏按钮事件
        startGameButton.addEventListener('click', function() {
            // 默认选择第一个章节
            chapter = 1;
            chapterSelectScreen.style.display = 'none';
            initChapter();
        });

        // 开始章节按钮事件
        chapterButtonsContainer.addEventListener('click', function(e) {
            if (e.target && e.target.nodeName === 'BUTTON') {
                const selectedChapter = parseInt(e.target.textContent.match(/章节 (\d+):/)[1]);
                chapter = selectedChapter;
                chapterSelectScreen.style.display = 'none';
                initChapter();
            }
        });

        // 初始化游戏
        showMainMenu();

    </script>
</body>
</html>
